<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Bordo Unificado Cosmos</title>
    

    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#8B5CF6" />



    <!-- CDNs (Consolidated) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@3.6.0/cdn.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/date-fns/3.6.0/locale/pt-BR.min.js" integrity="sha512-rZ8VOUgoR7U3X3z09kqX0vaJ8cMhJ7j3REKHx34kF3oAgCR2vVdSwyXFpXg4DCH91iHptQ3e51Z4BStx2kU/wA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- Fonts (Consolidated) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Orbitron:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🌠</text></svg>">

    <style>
        /* --- GLOBAL RESET & BASE --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }

        /* --- GLOBAL CSS VARIABLES (Merged from all files - ensure consistency) --- */
        :root {
            --font-body: 'Inter', sans-serif;
            --font-title: 'Orbitron', sans-serif;
            --cosmos-bg: #0D1117;
            --cosmos-text-primary: #E0E0E0;
            --cosmos-text-secondary: #A0AEC0;
            --cosmos-card-bg: rgba(29, 29, 40, 0.88);
            --cosmos-border: rgba(124, 58, 237, 0.40);
            --cosmos-border-hover: rgba(167, 139, 250, 0.7);
            --cosmos-shadow-strong: rgba(0, 0, 0, 0.55);
            --cosmos-shadow-soft-glow: rgba(167, 139, 250, 0.12);
            --cosmos-purple-primary: #A78BFA;
            --cosmos-purple-secondary: #C4B5FD;
            --cosmos-purple-dark: #8B5CF6;
            --cosmos-blue-accent: #60A5FA;
            --cosmos-pink-accent: #EC4899;
            --cosmos-cyan-accent: #6AF2F0;
            --cosmos-cyan-glow: rgba(106, 242, 240, 0.35);
            --cosmos-positive: #34D399;
            --cosmos-negative: #F87171;
            --cosmos-warning: #FBBF24;
            --cosmos-input-bg: rgba(13, 17, 23, 0.92);
            --cosmos-input-border: rgba(124, 58, 237, 0.45);
            --cosmos-input-focus-border: var(--cosmos-purple-primary);
            --cosmos-input-focus-shadow: rgba(167, 139, 250, 0.45);
            --cosmos-button-primary-bg-start: var(--cosmos-purple-dark); /* patrimonio.html style */
            --cosmos-button-primary-bg-end: var(--cosmos-blue-accent); /* patrimonio.html style */
            --cosmos-button-primary-hover-bg-start: var(--cosmos-purple-primary); /* patrimonio.html style */
            --cosmos-button-primary-hover-bg-end: var(--cosmos-cyan-accent); /* patrimonio.html style */
            
            --index-button-primary-gradient-start: #8B5CF6;
            --index-button-primary-gradient-end: #6366F1;
            --index-button-primary-hover-gradient-start: #7C3AED;
            --index-button-primary-hover-gradient-end: #4F46E5;

            --cosmos-button-delete-border: var(--cosmos-pink-accent);
            --cosmos-button-delete-text: var(--cosmos-pink-accent);
            --cosmos-button-delete-hover-bg: rgba(236, 72, 153, 0.18);
            --cosmos-button-delete-hover-text: #fda4af;
            --cosmos-button-edit-bg: #F59E0B;
            --cosmos-button-save-bg: var(--cosmos-positive);
            --cosmos-button-cancel-bg: #6B7280;
        }

        body {
            font-family: var(--font-body);
            line-height: 1.6;
            background-color: var(--cosmos-bg);
            color: var(--cosmos-text-primary);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
            padding-top: 70px; 
        }
        
        #starry-sky-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2;
            background-image:
                radial-gradient(ellipse at center, rgba(30, 27, 75, 0.12) 0%, transparent 70%),
                radial-gradient(ellipse at top left, rgba(80, 30, 70, 0.1) 0%, transparent 60%),
                radial-gradient(ellipse at bottom right, rgba(20, 50, 90, 0.1) 0%, transparent 60%),
                radial-gradient(circle at 10% 20%, rgba(210, 210, 255, 0.6) 0.5px, transparent 1px),
                radial-gradient(circle at 30% 50%, rgba(190, 210, 255, 0.5) 0.5px, transparent 1px),
                radial-gradient(circle at 70% 30%, rgba(220, 200, 255, 0.7) 0.5px, transparent 1px),
                radial-gradient(circle at 90% 60%, rgba(200, 200, 255, 0.4) 0.5px, transparent 1px),
                radial-gradient(circle at 50% 80%, rgba(220, 200, 255, 0.6) 0.5px, transparent 1px);
            background-size: 100% 100%, 100% 100%, 100% 100%, 50px 50px, 70px 70px, 60px 60px, 80px 80px, 90px 90px;
            opacity: 0;
            animation: subtleStarShine 35s infinite alternate ease-in-out, fadeInBg 3s 0.5s ease-out forwards;
            pointer-events: none; will-change: opacity, transform;
        }
        @keyframes subtleStarShine { 0% { opacity: 0.6; transform: scale(1.005) rotate(0.05deg); } 100% { opacity: 0.9; transform: scale(1) rotate(-0.05deg); } }
        @keyframes fadeInBg { to { opacity: 0.85; } }

        #main-nav {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: rgba(13, 17, 23, 0.9);
            backdrop-filter: blur(10px) saturate(150%);
            padding: 0.75rem 1.5rem;
            display: flex;
            justify-content: center; 
            align-items: center;
            gap: 1rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            border-bottom: 1px solid var(--cosmos-border);
        }
        #main-nav button {
            font-family: var(--font-title);
            font-size: 0.9em;
            font-weight: 500;
            color: var(--cosmos-text-secondary);
            background-color: transparent;
            border: 1px solid transparent;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: color 0.3s ease, background-color 0.3s ease, border-color 0.3s ease, transform 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        #main-nav button:hover {
            color: var(--cosmos-text-primary);
            background-color: rgba(167, 139, 250, 0.1);
            border-color: var(--cosmos-purple-primary);
            transform: translateY(-2px);
        }
        #main-nav button.active {
            color: var(--cosmos-cyan-accent);
            background-color: rgba(106, 242, 240, 0.15);
            border-color: var(--cosmos-cyan-accent);
            box-shadow: 0 0 10px var(--cosmos-cyan-glow);
            font-weight: 700;
        }
        
        .loading-spinner-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(13, 17, 23, 0.7); backdrop-filter: blur(5px);
            display: flex; justify-content: center; align-items: center;
            z-index: 2000; opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease, visibility 0s linear 0.3s;
        }
        .loading-spinner-overlay.visible { opacity: 1; visibility: visible; transition-delay: 0s; }
        .spinner {
            width: 60px; height: 60px; border: 5px solid rgba(106, 242, 240, 0.2);
            border-top-color: var(--cosmos-cyan-accent); border-radius: 50%;
            animation: spin 1s linear infinite, pulseSpinnerGlow 2s infinite alternate;
            box-shadow: 0 0 15px var(--cosmos-cyan-glow);
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes pulseSpinnerGlow {
            from { box-shadow: 0 0 10px rgba(106, 242, 240, 0.3); }
            to { box-shadow: 0 0 25px rgba(106, 242, 240, 0.6); }
        }

        #notification-container {
            position: fixed; bottom: 20px; right: 20px; z-index: 3000;
            display: flex; flex-direction: column-reverse; gap: 10px;
        }
        .notification-popup {
            font-family: var(--font-body); background-color: var(--cosmos-card-bg);
            color: var(--cosmos-text-primary); padding: 12px 18px; border-radius: 0.5rem;
            border-left: 5px solid var(--cosmos-blue-accent);
            box-shadow: 0 5px 20px var(--cosmos-shadow-strong), 0 0 12px var(--cosmos-shadow-soft-glow);
            opacity: 0; transform: translateX(120%);
            transition: opacity 0.4s ease-out, transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            min-width: 280px; max-width: 380px; font-size: 0.9em; line-height: 1.45;
            display: flex; align-items: center; cursor: pointer;
        }
        .notification-popup.show { opacity: 1; transform: translateX(0); }
        .notification-popup.success { border-left-color: var(--cosmos-positive); }
        .notification-popup.error { border-left-color: var(--cosmos-negative); }
        .notification-popup.warning { border-left-color: var(--cosmos-warning); }
        .notification-popup.info { border-left-color: var(--cosmos-blue-accent); }
        .notification-popup .icon { margin-right: 12px; font-size: 1.3em; line-height: 1; }
        .notification-popup.success .icon { color: var(--cosmos-positive); }
        .notification-popup.error .icon { color: var(--cosmos-negative); }
        .notification-popup.warning .icon { color: var(--cosmos-warning); }
        .notification-popup.info .icon { color: var(--cosmos-blue-accent); }

        .page-view {
            padding: 2rem; 
        }
        .page-view.hidden { display: none !important; }
        
        .container { max-width: 1200px; margin: 0 auto; width: 100%; } 
        #page-emprestimos .container { max-width: 1300px; } 


        /* --- STYLES FROM patrimonio.html (Scoped to #page-patrimonio) --- */
        #page-patrimonio header { text-align: center; margin-bottom: 2.5rem; animation: fadeInHeaderPatrimonio 1s ease-out; }
        @keyframes fadeInHeaderPatrimonio { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        #page-patrimonio header h1 {
            font-family: var(--font-title);
            color: var(--cosmos-text-primary); font-weight: 700; font-size: 2.5em;
            text-shadow: 0 0 12px var(--cosmos-cyan-glow), 0 0 8px var(--cosmos-purple-primary), 0 0 20px var(--cosmos-purple-dark); 
            background: linear-gradient(135deg, var(--cosmos-cyan-accent), var(--cosmos-purple-secondary), var(--cosmos-purple-dark), var(--cosmos-pink-accent));
            -webkit-background-clip: text; background-clip: text;
            -webkit-text-fill-color: transparent; text-fill-color: transparent;
            background-size: 300% auto; 
            animation: textGradientShinePatrimonio 6s linear infinite alternate, cosmicPulsePatrimonio 4s infinite ease-in-out;
        }
        @keyframes textGradientShinePatrimonio { to { background-position: 300% center; } }
        @keyframes cosmicPulsePatrimonio {
            0%, 100% { filter: brightness(1); transform: scale(1); }
            50% { filter: brightness(1.2); transform: scale(1.02); }
        }
        #page-patrimonio .secao {
            background-color: var(--cosmos-card-bg);
            backdrop-filter: blur(12px) saturate(130%); 
            border: 1px solid var(--cosmos-border);
            padding: 1.8rem 2rem; border-radius: 0.85rem;
            box-shadow: 0 8px 30px var(--cosmos-shadow-strong), inset 0 0 10px rgba(13,17,23,0.5), 0 0 10px var(--cosmos-shadow-soft-glow); 
            margin-bottom: 2.2rem;
            animation: popInSmoothPatrimonio 0.7s cubic-bezier(0.25, 0.8, 0.25, 1) backwards; 
            will-change: opacity, transform, box-shadow;
        }
        #page-patrimonio .secao:nth-child(1) { animation-delay: 0.15s; }
        #page-patrimonio .secao:nth-child(2) { animation-delay: 0.25s; }
        #page-patrimonio .secao:nth-child(3) { animation-delay: 0.35s; }
        #page-patrimonio .secao:nth-child(4) { animation-delay: 0.45s; }
        @keyframes popInSmoothPatrimonio { 0% { opacity: 0; transform: scale(0.95) translateY(20px); } 100% { opacity: 1; transform: scale(1) translateY(0); } }
        #page-patrimonio .secao:hover {
             transform: translateY(-5px) scale(1.005); 
             box-shadow: 0 14px 40px var(--cosmos-shadow-strong), 0 0 25px var(--cosmos-purple-primary), 0 0 10px var(--cosmos-cyan-glow), inset 0 0 12px rgba(13,17,23,0.6);
             border-color: var(--cosmos-border-hover);
        }
        #page-patrimonio .secao h2 {
            font-family: var(--font-title);
            color: var(--cosmos-text-primary); margin-bottom: 1.5rem; text-align: left; font-weight: 500; font-size: 1.6em;
            position: relative; padding-bottom: 0.6rem; 
            border-bottom: 2px solid transparent;
        }
        #page-patrimonio .secao h2::after { 
            content: ''; position: absolute; bottom: -2px; left: 0;
            width: 0%; height: 2px; 
            background: linear-gradient(90deg, var(--cosmos-cyan-accent), var(--cosmos-pink-accent), var(--cosmos-purple-primary));
            border-radius: 2px;
            transition: width 0.5s ease-in-out 0.1s; 
            box-shadow: 0 0 8px var(--cosmos-cyan-accent);
        }
        #page-patrimonio .secao:hover h2::after { width: 75%; } 
        #page-patrimonio .cards-container { display: flex; flex-wrap: wrap; gap: 1.5rem; justify-content: space-around; margin-bottom: 1rem; }
        #page-patrimonio .card {
            background: linear-gradient(145deg, rgba(35,40,60,0.92), rgba(25,30,45,0.97)); 
            border: 1px solid var(--cosmos-border);
            padding: 1.2rem 1.5rem; border-radius: 0.6rem;
            flex: 1 1 250px; min-width: 220px;
            box-shadow: 0 4px 18px var(--cosmos-shadow-strong), 0 0 8px var(--cosmos-shadow-soft-glow), inset 0 1px 2px rgba(13,17,23,0.4);
            transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
            position: relative; overflow: hidden; 
        }
        #page-patrimonio .card::before { 
            content: ""; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(106, 242, 240, 0.08), transparent);
            transition: left 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        #page-patrimonio .card:hover::before { left: 100%; }
        #page-patrimonio .card:hover {
            transform: translateY(-6px) scale(1.025);
            border-color: var(--cosmos-cyan-accent);
            box-shadow: 0 10px 30px var(--cosmos-shadow-strong), 0 0 20px var(--cosmos-cyan-glow), inset 0 1px 3px rgba(13,17,23,0.5);
        }
        #page-patrimonio .card h3 { font-family: var(--font-title); font-size: 1.0em; color: var(--cosmos-purple-secondary); font-weight: 500; margin-bottom: 0.5rem; }
        #page-patrimonio .card p { margin: 0.3rem 0; font-size: 1.3em; font-weight: 700; color: var(--cosmos-text-primary); }
        #page-patrimonio .card .subtext { font-size: 0.8em; font-weight: 400; color: var(--cosmos-text-secondary); opacity: 0.9; }
        #page-patrimonio .card .valor-card {}
        #page-patrimonio .card .positivo { color: var(--cosmos-positive) !important; text-shadow: 0 0 6px var(--cosmos-positive); animation: pulsePositivePatrimonio 2s infinite alternate; }
        #page-patrimonio .card .negativo { color: var(--cosmos-negative) !important; text-shadow: 0 0 6px var(--cosmos-negative); animation: pulseNegativePatrimonio 2s infinite alternate; }
        @keyframes pulsePositivePatrimonio { from { opacity: 0.8; filter: brightness(0.9); } to { opacity: 1; filter: brightness(1.1); } }
        @keyframes pulseNegativePatrimonio { from { opacity: 0.8; filter: brightness(0.9); } to { opacity: 1; filter: brightness(1.1); } }
        #page-patrimonio .card .mini-btn {
            background: rgba(106, 242, 240, 0.1); border: 1px solid rgba(106, 242, 240, 0.3);
            color: var(--cosmos-cyan-accent); padding: 0.2rem 0.5rem; border-radius: 0.25rem;
            font-size: 0.8em; cursor: pointer; margin-left: 0.5rem; transition: all 0.2s ease;
        }
        #page-patrimonio .card .mini-btn:hover { background: rgba(106, 242, 240, 0.2); border-color: var(--cosmos-cyan-accent); box-shadow: 0 0 5px var(--cosmos-cyan-glow); }
        #page-patrimonio .progress-bar-meta-bg { width: 100%; height: 10px; background-color: rgba(13,17,23,0.7); border-radius: 5px; margin-top: 0.5rem; overflow: hidden; border: 1px solid var(--cosmos-input-border); }
        #page-patrimonio .progress-bar-meta-fill { height: 100%; background-image: linear-gradient(90deg, var(--cosmos-positive), var(--cosmos-cyan-accent)); transition: width 0.5s ease-out; border-radius: 5px; box-shadow: 0 0 8px var(--cosmos-cyan-glow); }
        #page-patrimonio #patrimonioChartContainer { padding: 1.5rem; background-color: var(--cosmos-card-bg); border-radius: 0.85rem; border: 1px solid var(--cosmos-border); box-shadow: 0 8px 30px var(--cosmos-shadow-strong), inset 0 0 8px var(--cosmos-shadow-soft-glow); height: 400px; }
        #page-patrimonio .table-controls { display: flex; justify-content: flex-end; margin-bottom: 1rem; gap: 0.8rem; }
        #page-patrimonio table { width: 100%; border-collapse: separate; border-spacing: 0; background-color: rgba(15, 18, 30, 0.85); border-radius: 0.75rem; overflow: hidden; box-shadow: 0 5px 20px var(--cosmos-shadow-strong); border: 1px solid var(--cosmos-border); }
        #page-patrimonio th { background-color: rgba(20, 25, 45, 0.9); color: var(--cosmos-cyan-accent); font-weight: 600; padding: 0.8rem 1rem; font-family: var(--font-title); border-bottom: 2px solid var(--cosmos-cyan-accent); white-space: nowrap; font-size: 0.95em; text-align: left; text-shadow: 0 0 4px var(--cosmos-cyan-accent); }
        #page-patrimonio td { padding: 0.75rem 1rem; border-bottom: 1px solid var(--cosmos-input-border); vertical-align: middle; font-size: 0.9em; color: var(--cosmos-text-secondary); transition: background-color 0.2s ease, color 0.2s ease; }
        #page-patrimonio tbody tr:last-child td { border-bottom: none; }
        #page-patrimonio tbody tr:nth-child(even) { background-color: rgba(20, 25, 45, 0.5); }
        #page-patrimonio tbody tr:hover { background-color: rgba(106, 242, 240, 0.07); color: var(--cosmos-text-primary); }
        #page-patrimonio tbody tr:hover td { color: var(--cosmos-cyan-accent); }
        #page-patrimonio .positivo { color: var(--cosmos-positive) !important; font-weight: 600; text-shadow: 0 0 4px var(--cosmos-positive); }
        #page-patrimonio .negativo { color: var(--cosmos-negative) !important; font-weight: 600; text-shadow: 0 0 4px var(--cosmos-negative); }
        #page-patrimonio #addEntryForm { margin-top: 1.5rem; padding: 1.5rem; background-color: rgba(20,25,40,0.7); border-radius: 0.75rem; border: 1px solid var(--cosmos-border); box-shadow: 0 0 10px var(--cosmos-shadow-soft-glow); }
        #page-patrimonio #addEntryForm h3 { font-family: var(--font-title); color: var(--cosmos-purple-secondary); font-weight: 500; font-size: 1.3em; margin-bottom: 1rem; }
        #page-patrimonio #addEntryForm input, #page-patrimonio #addEntryForm select { padding: 0.7rem 0.9rem; margin-right: 0.8rem; margin-bottom: 0.8rem; border: 1px solid var(--cosmos-input-border); border-radius: 0.375rem; background-color: var(--cosmos-input-bg); color: var(--cosmos-text-primary); font-family: var(--font-body); font-size: 0.95em; transition: border-color 0.2s ease, box-shadow 0.2s ease; }
        #page-patrimonio #addEntryForm input::placeholder { color: var(--cosmos-text-secondary); opacity: 0.7; }
        #page-patrimonio #addEntryForm input:focus, #page-patrimonio #addEntryForm select:focus { outline: none; border-color: var(--cosmos-input-focus-border); box-shadow: 0 0 0 3px var(--cosmos-input-focus-shadow), 0 0 8px var(--cosmos-cyan-glow); }
        #page-patrimonio .table-controls button, #page-patrimonio #addEntryForm button, #page-patrimonio .row-delete-btn {
            border: none; padding: 0.7rem 1.3rem;  border-radius: 0.375rem;
            cursor: pointer; font-weight: 500; font-size: 0.9em;
            transition: all 0.25s ease-out; 
            color: #fff; position: relative; overflow: hidden;
            text-shadow: 0 1px 2px rgba(0,0,0,0.25);
            box-shadow: 0 2px 5px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.05); 
        }
        #page-patrimonio .table-controls button:hover, #page-patrimonio #addEntryForm button:hover, #page-patrimonio .row-delete-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 12px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.08), 0 0 10px var(--cosmos-cyan-glow); 
        }
        #page-patrimonio .table-controls button::before, #page-patrimonio #addEntryForm button::before, #page-patrimonio .row-delete-btn::before { 
             content: ""; position: absolute; top: 50%; left: 50%; width: 0; height: 0;
            background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%);
            transform: translate(-50%, -50%); border-radius: 50%; opacity: 0;
            transition: width 0.4s ease, height 0.4s ease, opacity 0.4s ease;
        }
        #page-patrimonio .table-controls button:hover::before, #page-patrimonio #addEntryForm button:hover::before, #page-patrimonio .row-delete-btn:hover::before {
            width: 200%; height: 200%; opacity: 1;
        }
        #page-patrimonio .table-controls button:active, #page-patrimonio #addEntryForm button:active, #page-patrimonio .row-delete-btn:active { transform: translateY(0px) scale(0.98); box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        #page-patrimonio #toggleEditModeBtn { background-color: var(--cosmos-button-edit-bg); }
        #page-patrimonio #toggleEditModeBtn::after { content: ' 🛠️'; } 
        #page-patrimonio #saveAllBtn, #page-patrimonio #addEntryForm .save-btn { background-image: linear-gradient(135deg, var(--cosmos-button-save-bg) 0%, #10B981 100%); }
        #page-patrimonio #saveAllBtn::after { content: ' 💾'; }
        #page-patrimonio #addEntryForm .save-btn::after { content: ' ✨'; }
        #page-patrimonio #cancelEditBtn { background-color: var(--cosmos-button-cancel-bg); }
        #page-patrimonio #cancelEditBtn::after { content: ' ↩️'; }
        #page-patrimonio .row-delete-btn { background-color: transparent; border: 1px solid var(--cosmos-button-delete-border); color: var(--cosmos-button-delete-text); padding: 0.4rem 0.8rem; font-size: 0.85em; }
        #page-patrimonio .row-delete-btn::after { content: ' 🗑️'; margin-left: 4px;}
        #page-patrimonio .row-delete-btn:hover { background-color: var(--cosmos-button-delete-hover-bg); color: var(--cosmos-button-delete-hover-text); border-color: var(--cosmos-button-delete-hover-text); }
        #page-patrimonio td input[type="text"], #page-patrimonio td input[type="number"], #page-patrimonio td input[type="date"] { width: 100%; padding: 0.5rem; background-color: var(--cosmos-input-bg); color: var(--cosmos-text-primary); border: 1px solid var(--cosmos-input-border); border-radius: 0.25rem;}
        #page-patrimonio td input:focus { outline: none; border-color: var(--cosmos-input-focus-border); box-shadow: 0 0 0 2px var(--cosmos-input-focus-shadow); }
        #page-patrimonio .editing-row td:last-child { text-align: center; }
        #page-patrimonio #themeToggle { display: none; }
        #page-patrimonio .resumo-agregado h2 { text-align: center; }
        #page-patrimonio .resumo-controles { display: flex; justify-content: center; align-items: center; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
        #page-patrimonio .resumo-controles label { font-size: 0.9em; color: var(--cosmos-text-secondary); }
        #page-patrimonio .resumo-controles select { padding: 0.5rem 0.8rem; background-color: var(--cosmos-input-bg); color: var(--cosmos-text-primary); border: 1px solid var(--cosmos-input-border); border-radius: 0.375rem; font-family: var(--font-body); min-width: 120px; }
        #page-patrimonio #resumoAgregadoContainer { margin-top: 1rem; text-align: center; }
        #page-patrimonio .placeholder-resumo { color: var(--cosmos-text-secondary); font-style: italic; }
        #page-patrimonio .resumo-item { background-color: rgba(20,25,40,0.7); padding: 1rem; border-radius: 0.5rem; margin-bottom: 0.8rem; border: 1px solid var(--cosmos-border); text-align: left; }
        #page-patrimonio .resumo-item h4 { font-family: var(--font-title); color: var(--cosmos-purple-secondary); margin-bottom: 0.5rem; font-size: 1.1em; }
        #page-patrimonio .resumo-item p { font-size: 0.95em; margin-bottom: 0.3rem; color: var(--cosmos-text-secondary); }
        #page-patrimonio .resumo-item p strong { color: var(--cosmos-text-primary); margin-left: 0.3rem; }
        #page-patrimonio .resumo-item .positivo { color: var(--cosmos-positive) !important; }
        #page-patrimonio .resumo-item .negativo { color: var(--cosmos-negative) !important; }
        @media (max-width: 600px) {
            #page-patrimonio #notification-container { right: 10px; bottom: 10px; left: 10px; align-items: stretch; }
            #page-patrimonio .notification-popup { min-width: unset; width: 100%; }
        }
        /* End of patrimonio.html styles */


        /* --- STYLES FROM index.html (Scoped to #page-emprestimos) --- */
        #page-emprestimos .font-orbitron { font-family: 'Orbitron', sans-serif; }
        #page-emprestimos .total-counter-wrapper { 
            position: relative; 
            margin: 1rem auto 1.5rem auto; 
            z-index: 1; 
        }
        #page-emprestimos .total-counter-container {
            position: relative;
            background: linear-gradient(145deg, rgba(124, 58, 237, 0.25), rgba(99, 102, 241, 0.2)); 
            border: 1px solid rgba(167, 139, 250, 0.4); 
            color: #E0E0E0; border-radius: 50px; 
            box-shadow: 0 0 20px rgba(124, 58, 237, 0.3), inset 0 0 10px rgba(124, 58, 237, 0.1);
            white-space: nowrap; display: flex; flex-direction: column; align-items: stretch;
            cursor: pointer; overflow: hidden;
            min-height: calc(1.1em + 1.4rem); max-height: calc(1.1em + 1.4rem);
            transition: max-height 0.5s cubic-bezier(0.25, 0.8, 0.25, 1), border-radius 0.4s ease-in-out,
                        box-shadow 0.4s ease, background 0.4s ease;
            width: fit-content; padding: 0;
        }
        #page-emprestimos .total-counter-container:hover {
            max-height: 500px; border-radius: 20px; 
            background: linear-gradient(145deg, rgba(124, 58, 237, 0.4), rgba(99, 102, 241, 0.35));
            box-shadow: 0 10px 35px rgba(124, 58, 237, 0.5), inset 0 0 15px rgba(167, 139, 250, 0.15);
        }
        #page-emprestimos .counter-main { display: flex; justify-content: center; align-items: center; gap: 8px; padding: 0.7rem 1.5rem; flex-shrink: 0; line-height: 1.1em; }
        #page-emprestimos .counter-main span:first-child { font-weight: 500; font-size: 0.9em; color: #C4B5FD; } 
        #page-emprestimos #valorCirculacaoPrincipal { font-family: 'Orbitron', sans-serif; font-size: 1.2em; font-weight: 700; color: #fff; text-shadow: 0 0 8px rgba(192, 132, 252, 0.7); }
        #page-emprestimos .counter-details {
            width: 100%; padding: 1rem 1.5rem 0.8rem 1.5rem; margin-top: 0.6rem;
            border-top: 1px solid rgba(167, 139, 250, 0.3);
            opacity: 0; transform: translateY(-8px) scaleY(0.98);
            transform-origin: top center;
            transition: opacity 0.4s ease-out 0.1s, transform 0.4s ease-out 0.1s;
            pointer-events: none;
        }
        #page-emprestimos .total-counter-container:hover .counter-details { opacity: 1; transform: translateY(0) scaleY(1); pointer-events: auto; }
        #page-emprestimos .counter-details p { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.7rem; font-size: 0.85em; }
        #page-emprestimos .counter-details p:last-child { margin-bottom: 0; }
        #page-emprestimos .counter-details span:first-child { color: #D1D5DB; margin-right: 10px; flex-shrink: 0; }
        #page-emprestimos .counter-details span:last-child { font-weight: 600; text-align: right; word-break: break-all; }
        #page-emprestimos #totalGirando { color: #A78BFA; }
        #page-emprestimos #valorLucroReceber { color: var(--cosmos-warning); }
        #page-emprestimos #valorMediaPorcentagem { color: var(--cosmos-blue-accent); }
        #page-emprestimos #valorLucroRealizado { color: var(--cosmos-positive); }

        #page-emprestimos main { flex: 1; padding: 0; display: flex; flex-direction: column; justify-content: flex-start; align-items: center; animation: fadeInEmprestimos 1s ease-out; position: relative; z-index: 1; }
        @keyframes fadeInEmprestimos { from { opacity: 0; } to { opacity: 1; } }
        #page-emprestimos .client-data, #page-emprestimos .client-summary, #page-emprestimos .financial-analysis, #page-emprestimos .cash-flow-analysis {
            background-color: rgba(29, 29, 40, 0.75); 
            backdrop-filter: blur(12px) saturate(120%);
            border: 1px solid transparent;
            border-image: linear-gradient(145deg, rgba(107, 33, 168, 0.4), rgba(79, 70, 229, 0.3), rgba(59, 130, 246, 0.4)) 1; 
            padding: 2rem 2.5rem; border-radius: 1rem; 
            box-shadow: 0 10px 35px rgba(0, 0, 0, 0.4), inset 0 0 10px rgba(167, 139, 250, 0.05);
            width: 100%; max-width: 1300px; 
            margin: 0 auto 2.5rem auto;
            transition: transform 0.35s cubic-bezier(0.25, 0.8, 0.25, 1), box-shadow 0.35s cubic-bezier(0.25, 0.8, 0.25, 1), border-image 0.35s ease-out;
            will-change: opacity, transform, box-shadow;
        }
        #page-emprestimos .client-summary, #page-emprestimos .financial-analysis, #page-emprestimos .cash-flow-analysis {
             opacity: 0; transform: translateY(35px) scale(0.98);
             transition: opacity 0.7s ease-out, transform 0.7s ease-out,
                         box-shadow 0.35s ease, border-image 0.35s ease;
        }
        #page-emprestimos .client-data { animation: popInSmoothEmprestimos 0.7s ease-out 0.1s backwards; }
        @keyframes popInSmoothEmprestimos { 0% { opacity: 0; transform: scale(0.95); } 100% { opacity: 1; transform: scale(1); } }
        #page-emprestimos .client-summary.visible, #page-emprestimos .financial-analysis.visible, #page-emprestimos .cash-flow-analysis.visible { opacity: 1; transform: translateY(0) scale(1); }
        #page-emprestimos .client-data:hover, #page-emprestimos .client-summary:hover, #page-emprestimos .financial-analysis:hover, #page-emprestimos .cash-flow-analysis:hover {
             transform: translateY(-6px) scale(1.01);
             box-shadow: 0 15px 45px rgba(0,0,0, 0.5), 0 0 25px rgba(124, 58, 237, 0.2);
             border-image: linear-gradient(145deg, rgba(167, 139, 250, 0.7), rgba(124, 58, 237, 0.6), rgba(96, 165, 250, 0.6)) 1;
        }
        #page-emprestimos .client-data h2, #page-emprestimos .client-summary h2, #page-emprestimos .financial-analysis h2, #page-emprestimos .cash-flow-analysis h2 {
            font-family: 'Orbitron', sans-serif;
            color: #fff; margin-bottom: 1.8rem; text-align: center; font-weight: 600; font-size: 2em; 
            position: relative; display: inline-block; left: 50%; transform: translateX(-50%); 
            padding-bottom: 0.5rem;
        }
        #page-emprestimos .client-data h2::after, #page-emprestimos .client-summary h2::after, #page-emprestimos .financial-analysis h2::after, #page-emprestimos .cash-flow-analysis h2::after {
            content: ''; position: absolute; bottom: -5px; left: 50%; transform: translateX(-50%);
            width: 60%; height: 3px;
            background: linear-gradient(90deg, transparent, #A78BFA, #EC4899, transparent); 
            border-radius: 3px; opacity: 0.7;
            transition: opacity 0.4s ease-in-out, width 0.4s ease-in-out;
        }
        #page-emprestimos .client-data:hover h2::after, #page-emprestimos .client-summary:hover h2::after, #page-emprestimos .financial-analysis:hover h2::after, #page-emprestimos .cash-flow-analysis:hover h2::after {
             width: 80%; opacity: 0.9;
        }
        #page-emprestimos .client-data p { text-align: center; margin-bottom: 2rem; font-size: 1em; color: #D1D5DB; }
        #page-emprestimos table {
            width: 100%; border-collapse: separate; border-spacing: 0; margin-bottom: 2.5rem;
            background-color: rgba(20, 20, 30, 0.7); 
            border-radius: 12px; overflow: hidden; 
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.4);
            table-layout: fixed; word-wrap: break-word;
            border: 1px solid rgba(124, 58, 237, 0.2); 
        }
        #page-emprestimos th {
            background-color: rgba(40, 40, 55, 0.85); 
            color: #C4B5FD; 
            font-weight: 600; padding: 0.9rem 1rem;
            border-bottom: 2px solid rgba(167, 139, 250, 0.4); 
            white-space: normal; font-size: 0.9em; vertical-align: middle;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        #page-emprestimos td {
            padding: 0.8rem 1rem; border-bottom: 1px solid rgba(124, 58, 237, 0.15); 
            vertical-align: middle; transition: background-color 0.3s ease, color 0.3s ease;
            white-space: normal; font-size: 0.85em; color: #D1D5DB; 
        }
        #page-emprestimos col:nth-child(1) { width: 15%; } #page-emprestimos col:nth-child(2) { width: 18%; } #page-emprestimos col:nth-child(3) { width: 13%; } #page-emprestimos col:nth-child(4) { width: 10%; } #page-emprestimos col:nth-child(5) { width: 8%; } #page-emprestimos col:nth-child(6) { width: 10%; } #page-emprestimos col:nth-child(7) { width: 10%; } #page-emprestimos col:nth-child(8) { width: 13%; } #page-emprestimos col:nth-child(9) { width: 5%; } #page-emprestimos col:nth-child(10) { width: 8%; }
        #page-emprestimos td:nth-child(1) { font-size: 0.7em; word-break: break-all; opacity: 0.65; color: #A0AEC0; }
        #page-emprestimos td:nth-child(3), #page-emprestimos td:nth-child(4), #page-emprestimos td:nth-child(8) { text-align: right; font-feature-settings: "tnum"; font-variant-numeric: tabular-nums; }
        #page-emprestimos td:nth-child(5), #page-emprestimos td:nth-child(6), #page-emprestimos td:nth-child(7), #page-emprestimos td:nth-child(9), #page-emprestimos td:nth-child(10) { text-align: center; }
        #page-emprestimos tbody tr { transition: background-color 0.25s ease, transform 0.25s ease-out; }
        #page-emprestimos tbody tr:nth-child(even) { background-color: rgba(40, 40, 55, 0.4); } 
        #page-emprestimos tbody tr:hover {
            background-color: rgba(87, 83, 182, 0.4); 
            transform: translateY(-2px); box-shadow: 0 5px 12px rgba(124, 58, 237, 0.25);
            position: relative; z-index: 5;
        }
        #page-emprestimos tbody tr:hover td { color: #fff; } #page-emprestimos tbody tr:last-child td { border-bottom: none; }
        #page-emprestimos tbody tr.row-entering { opacity: 0; transform: translateY(15px) scale(0.98); transition: opacity 0.6s ease-out, transform 0.6s ease-out; }
        #page-emprestimos tbody tr.row-entering.visible { opacity: 1; transform: translateY(0) scale(1); }
        #page-emprestimos tbody tr.row-exiting { opacity: 1; transform: translateX(0) scale(1); transition: opacity 0.4s ease-in, transform 0.4s ease-in; }
        #page-emprestimos tbody tr.row-exiting.hidden { opacity: 0; transform: translateX(-30px) scale(0.95); }
        #page-emprestimos td.percentage-cell { font-style: italic; color: #A78BFA; opacity: 0.9; }
        #page-emprestimos tbody tr:hover td.percentage-cell { color: #DDD6FE; opacity: 1; }
        #page-emprestimos td input[type="text"], #page-emprestimos td input[type="number"], #page-emprestimos td input[type="date"] {
            width: 100%; padding: 0.5rem 0.7rem;
            border: 1px solid rgba(124, 58, 237, 0.35); 
            border-radius: 6px; font-family: inherit; font-size: 0.95em;
            background-color: rgba(13, 17, 23, 0.8); 
            color: #E0E0E0; transition: all 0.25s ease-in-out;
        }
        #page-emprestimos td input[type="number"] { text-align: right; } #page-emprestimos td input[type="date"] { text-align: center; }
        #page-emprestimos td input:focus {
            outline: none; background-color: #0D1117;
            border-color: #A78BFA; box-shadow: 0 0 0 2px rgba(167, 139, 250, 0.4); 
        }
        #page-emprestimos td.editing { background-color: rgba(87, 83, 182, 0.2) !important; padding: 0.15rem; }
        #page-emprestimos td.editing input { padding: 0.6rem 0.7rem; }
        #page-emprestimos td input[type="checkbox"] {
            appearance: none; -webkit-appearance: none;
            width: 40px; height: 20px; background-color: rgba(107, 114, 128, 0.5); 
            border-radius: 10px; cursor: pointer; vertical-align: middle;
            position: relative; transition: background-color 0.3s ease;
            border: 1px solid rgba(167, 139, 250, 0.3);
        }
        #page-emprestimos td input[type="checkbox"]::before { 
            content: ''; position: absolute;
            width: 14px; height: 14px; background-color: #E0E0E0;
            border-radius: 50%; top: 2px; left: 3px;
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        #page-emprestimos td input[type="checkbox"]:hover { filter: brightness(1.1); }
        #page-emprestimos td input[type="checkbox"]:checked {
            background-image: linear-gradient(135deg, var(--index-button-primary-gradient-start) 0%, var(--index-button-primary-gradient-end) 100%); 
            border-color: transparent;
            box-shadow: 0 0 8px rgba(124, 58, 237, 0.5);
        }
        #page-emprestimos td input[type="checkbox"]:checked::before {
            transform: translateX(20px); 
            background-color: #fff;
        }
        #page-emprestimos .action-button, #page-emprestimos .delete-button, #page-emprestimos .modal-button {
            border: none; padding: 0.8rem 1.8rem; border-radius: 0.5rem; 
            cursor: pointer; font-weight: 600; font-size: 0.9em;
            transition: all 0.25s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative; overflow: hidden;
            text-shadow: 0 1px 1px rgba(0,0,0,0.15); transform-origin: center; will-change: transform, box-shadow;
        }
        #page-emprestimos .action-button, #page-emprestimos .modal-button-confirm {
            color: white;
            background-image: linear-gradient(135deg, var(--index-button-primary-gradient-start) 0%, var(--index-button-primary-gradient-end) 100%);
            box-shadow: 0 4px 15px rgba(107, 33, 168, 0.3), 0 1px 3px rgba(0,0,0,0.2);
            display: block; width: fit-content; margin: 2rem auto 0 auto;
        }
        #page-emprestimos .action-button::before, #page-emprestimos .modal-button-confirm::before { 
            content: ""; position: absolute; top: 50%; left: 50%; width: 300%; height: 300%;
            background: radial-gradient(circle, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0) 60%);
            transform: translate(-50%, -50%) scale(0);
            transition: transform 0.4s ease-out, opacity 0.4s ease-out; opacity: 0; border-radius: 50%;
        }
        #page-emprestimos .action-button:hover, #page-emprestimos .modal-button-confirm:hover {
            background-image: linear-gradient(135deg, var(--index-button-primary-hover-gradient-start) 0%, var(--index-button-primary-hover-gradient-end) 100%);
            transform: translateY(-3px) scale(1.03);
            box-shadow: 0 8px 25px rgba(107, 33, 168, 0.4), 0 3px 8px rgba(0,0,0,0.25);
        }
        #page-emprestimos .action-button:hover::before, #page-emprestimos .modal-button-confirm:hover::before {
            transform: translate(-50%, -50%) scale(1); opacity: 1;
        }
        #page-emprestimos .action-button:active, #page-emprestimos .modal-button-confirm:active {
            transform: translateY(-1px) scale(0.97); box-shadow: 0 2px 8px rgba(107, 33, 168, 0.3);
        }
        #page-emprestimos .delete-button, #page-emprestimos .modal-button-cancel {
            border: 2px solid #A78BFA; 
            color: #C4B5FD; background-color: transparent;
            padding: 0.35rem 0.7rem; font-size: 0.8em; border-radius: 0.375rem;
            display: inline-flex; align-items: center; justify-content: center; vertical-align: middle;
        }
        #page-emprestimos .delete-button:hover, #page-emprestimos .modal-button-cancel:hover {
            background-color: rgba(167, 139, 250, 0.15); color: #DDD6FE; border-color: #C4B5FD;
            transform: translateY(-2px) scale(1.03);
            box-shadow: 0 0 15px rgba(167, 139, 250, 0.3);
        }
        #page-emprestimos .delete-button:active, #page-emprestimos .modal-button-cancel:active {
            transform: translateY(0px) scale(0.98); background-color: rgba(167, 139, 250, 0.25);
        }
        #page-emprestimos .modal-button { padding: 0.7rem 1.5rem; font-size: 0.9em; box-shadow: 0 3px 10px rgba(0, 0, 0, 0.25); }
        #page-emprestimos .action-button span, #page-emprestimos .delete-button span, #page-emprestimos .modal-button span { position: relative; z-index: 1; }
        #page-emprestimos .summary-content-wrapper { display: flex; flex-wrap: wrap; gap: 2rem; align-items: flex-start; }
        #page-emprestimos .client-summary-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(230px, 1fr)); gap: 1.5rem; flex: 2 1 480px; min-width: 280px; }
        #page-emprestimos .summary-placeholder { grid-column: 1 / -1; text-align: center; color: #A0AEC0; font-style: italic; padding: 2.5rem 0; font-size: 1em; }
        #page-emprestimos .client-summary-item { 
            background: linear-gradient(145deg, rgba(40, 40, 60, 0.85), rgba(25, 25, 40, 0.9)); 
            padding: 1.2rem; border-radius: 0.75rem;
            border: 1px solid rgba(167, 139, 250, 0.2);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            display: flex; flex-direction: column; gap: 0.6rem;
            opacity: 0; transform: scale(0.95) rotate(-2deg);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out, box-shadow 0.3s ease, background 0.3s ease;
            will-change: opacity, transform, box-shadow;
        }
        #page-emprestimos .client-summary.visible .client-summary-item { opacity: 1; transform: scale(1) rotate(0deg); }
        #page-emprestimos .client-summary.visible .client-summary-item:nth-child(1) { transition-delay: 0.1s; } #page-emprestimos .client-summary.visible .client-summary-item:nth-child(2) { transition-delay: 0.15s; } #page-emprestimos .client-summary.visible .client-summary-item:nth-child(3) { transition-delay: 0.2s; } #page-emprestimos .client-summary.visible .client-summary-item:nth-child(4) { transition-delay: 0.25s; } #page-emprestimos .client-summary.visible .client-summary-item:nth-child(5) { transition-delay: 0.3s; }
        #page-emprestimos .client-summary-item:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 8px 25px rgba(124, 58, 237, 0.3);
            background: linear-gradient(145deg, rgba(50, 50, 70, 0.9), rgba(35, 35, 50, 0.95));
        }
        #page-emprestimos .client-summary-item .client-name { font-size: 1.05em; font-weight: 600; color: #DDD6FE; margin-bottom: 0.5rem; word-break: break-all; }
        #page-emprestimos .client-summary-item .client-total-due {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.25em; font-weight: 700; color: #6EE7B7; 
            text-shadow: 0 0 6px rgba(74, 222, 128, 0.4);
            text-align: right; margin-top: auto;
        }
        #page-emprestimos .client-chart-container { 
            flex: 1 1 360px; min-width: 300px; padding: 1.2rem;
            background-color: rgba(25, 25, 40, 0.7); border-radius: 0.75rem;
            border: 1px solid rgba(167, 139, 250, 0.15);
            display: flex; justify-content: center; align-items: center; position: relative; min-height: 300px;
            opacity: 0; transform: scale(0.95) rotate(2deg);
            transition: opacity 0.6s ease-out 0.2s, transform 0.6s ease-out 0.2s;
            will-change: opacity, transform;
        }
        #page-emprestimos .client-summary.visible .client-chart-container { opacity: 1; transform: scale(1) rotate(0deg); }
        #page-emprestimos #clientDebtChart { max-width: 100%; max-height: 380px; }
        #page-emprestimos .chart-placeholder { color: #A0AEC0; font-style: italic; text-align: center; font-size: 1em; }
        #page-emprestimos .investment-limit-container { 
            background-color: rgba(20, 20, 30, 0.65); padding: 1.2rem 1.8rem;
            border-radius: 0.75rem; margin-bottom: 2rem;
            border: 1px solid rgba(124, 58, 237, 0.2);
        }
        #page-emprestimos .investment-limit-container h3 { text-align: center; color: #DDD6FE; font-family: 'Orbitron', sans-serif; font-weight: 500; font-size: 1.15em; margin-bottom: 1.2rem; }
        #page-emprestimos .limit-details { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.8rem; margin-bottom: 0.8rem; font-size: 0.9em; color: #D1D5DB; }
        #page-emprestimos .limit-details span strong { color: #E0E0E0; font-weight: 600; margin-left: 4px; font-feature-settings: "tnum"; font-variant-numeric: tabular-nums; }
        #page-emprestimos .limit-details span strong.available { color: #6EE7B7; text-shadow: 0 0 4px #6EE7B7; }
        #page-emprestimos .limit-details span strong.warning { color: var(--cosmos-warning); text-shadow: 0 0 4px var(--cosmos-warning); }
        #page-emprestimos .limit-details span strong.danger { color: var(--cosmos-negative); text-shadow: 0 0 4px var(--cosmos-negative); }
        #page-emprestimos .progress-bar-bg { 
            width: 100%; height: 16px; background-color: rgba(13, 17, 23, 0.9);
            border-radius: 50px; overflow: hidden;
            border: 1px solid rgba(124, 58, 237, 0.15);
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.4); margin-bottom: 0.5rem;
        }
        #page-emprestimos .progress-bar-fill {
            height: 100%;
            background-image: linear-gradient(135deg, var(--index-button-primary-gradient-start) 0%, var(--index-button-primary-gradient-end) 50%, var(--cosmos-purple-primary) 100%); 
            background-size: 250% 100%; border-radius: 50px;
            transition: width 0.7s ease-out;
            box-shadow: 0 0 8px rgba(167, 139, 250, 0.4);
            animation: progressShineEmprestimos 3.5s linear infinite;
        }
        @keyframes progressShineEmprestimos { to { background-position: 250% 100%; } }
        #page-emprestimos .progress-percentage { text-align: right; font-size: 0.8em; color: #C4B5FD; font-weight: 500; }
        #page-emprestimos .additional-charts-container { display: flex; flex-wrap: wrap; gap: 1.8rem; justify-content: center; }
        #page-emprestimos .chart-box { 
            background: linear-gradient(145deg, rgba(40, 40, 60, 0.85), rgba(25, 25, 40, 0.9));
            padding: 1.2rem; border-radius: 0.75rem;
            border: 1px solid rgba(167, 139, 250, 0.2);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            flex: 1 1 380px; min-width: 280px; display: flex; flex-direction: column;
            opacity: 0; transform: scale(0.95) rotate(-1.5deg);
            transition: opacity 0.5s ease-out 0.2s, transform 0.5s ease-out 0.2s, box-shadow 0.3s ease, background 0.3s ease;
            will-change: opacity, transform, box-shadow;
        }
        #page-emprestimos .financial-analysis.visible .chart-box { opacity: 1; transform: scale(1) rotate(0deg); }
        #page-emprestimos .financial-analysis.visible .chart-box:nth-child(1) { transition-delay: 0.3s; }
        #page-emprestimos .financial-analysis.visible .chart-box:nth-child(2) { transition-delay: 0.4s; }
        #page-emprestimos .chart-box:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 8px 25px rgba(124, 58, 237, 0.3);
            background: linear-gradient(145deg, rgba(50, 50, 70, 0.9), rgba(35, 35, 50, 0.95));
        }
        #page-emprestimos .chart-box h4 { text-align: center; color: #DDD6FE; font-family: 'Orbitron', sans-serif; font-weight: 500; margin-bottom: 1.2rem; font-size: 1.1em; }
        #page-emprestimos .chart-wrapper { position: relative; width: 100%; flex-grow: 1; min-height: 240px; display: flex; justify-content: center; align-items: center; }
        #page-emprestimos .chart-wrapper canvas { max-width: 100%; max-height: 340px; }
        #page-emprestimos .cash-flow-analysis .chart-box { 
            flex-basis: 100%;
            opacity: 0; transform: scale(0.98) translateY(25px);
            transition: opacity 0.7s ease-out 0.3s, transform 0.7s ease-out 0.3s;
            will-change: opacity, transform;
        }
        #page-emprestimos .cash-flow-analysis.visible .chart-box { opacity: 1; transform: scale(1) translateY(0); }
        #page-emprestimos .cash-flow-analysis .chart-wrapper { min-height: 310px; }
        #page-emprestimos #cashFlowChart { max-width: 100%; max-height: 460px; }
        #page-emprestimos .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(13, 17, 23, 0.8); 
            backdrop-filter: blur(6px) saturate(110%);
            display: flex; justify-content: center; align-items: center; z-index: 1050;
            opacity: 0; visibility: hidden; transition: opacity 0.35s ease, visibility 0s linear 0.35s;
        }
        #page-emprestimos .modal-overlay.active { opacity: 1; visibility: visible; transition: opacity 0.35s ease, visibility 0s linear 0s; }
        #page-emprestimos .modal-container { 
            background: linear-gradient(145deg, rgba(40, 40, 60, 0.98), rgba(25, 25, 40, 0.98));
            border: 1px solid rgba(167, 139, 250, 0.3);
            padding: 2rem 2.5rem; border-radius: 0.75rem;
            box-shadow: 0 8px 35px rgba(0, 0, 0, 0.5);
            text-align: center; color: #E0E0E0; max-width: 440px; width: 90%;
            transform: scale(0.85) rotate(-3deg); opacity: 0;
            transition: opacity 0.45s ease-out, transform 0.45s ease-out;
            will-change: transform, opacity;
        }
        #page-emprestimos .modal-overlay.active .modal-container { opacity: 1; animation: popInModalSmoothEmprestimos 0.55s ease-out forwards; }
        @keyframes popInModalSmoothEmprestimos {
            0% { transform: scale(0.85) rotate(-3deg); opacity: 0; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }
        #page-emprestimos .modal-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5em; font-weight: 600; margin-bottom: 0.8rem;
            color: var(--cosmos-negative); 
            text-shadow: 0 0 8px rgba(248, 113, 113, 0.5);
        }
        #page-emprestimos .modal-message { font-size: 0.95em; margin-bottom: 1.8rem; line-height: 1.65; color: #D1D5DB; }
        #page-emprestimos .modal-message strong { color: #FCA5A5; font-weight: 600; }
        #page-emprestimos .modal-actions { display: flex; justify-content: center; gap: 1rem; }
        @media (max-width: 768px) { #page-emprestimos .total-counter-wrapper { position: relative; margin: 1.2rem auto 0 auto;} }
        /* End of index.html styles */

        /* --- STYLES FROM terer.html (Scoped to #page-gastos) --- */
        #page-gastos header { text-align: center; margin-bottom: 2.5rem; animation: fadeInHeaderGastos 1s ease-out; }
        @keyframes fadeInHeaderGastos { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        #page-gastos header h1 {
            font-family: var(--font-title); color: var(--cosmos-text-primary); font-weight: 700; font-size: 2.5em;
            text-shadow: 0 0 12px var(--cosmos-cyan-glow), 0 0 8px var(--cosmos-purple-primary), 0 0 20px var(--cosmos-purple-dark);
            background: linear-gradient(135deg, var(--cosmos-cyan-accent), var(--cosmos-purple-secondary), var(--cosmos-purple-dark), var(--cosmos-pink-accent));
            -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; text-fill-color: transparent;
            background-size: 300% auto; animation: textGradientShineGastos 6s linear infinite alternate, cosmicPulseGastos 4s infinite ease-in-out;
        }
        @keyframes textGradientShineGastos { to { background-position: 300% center; } }
        @keyframes cosmicPulseGastos { 0%, 100% { filter: brightness(1); transform: scale(1); } 50% { filter: brightness(1.2); transform: scale(1.02); } }
        #page-gastos .container { max-width: 1300px; margin: 0 auto; width: 100%; }
        #page-gastos .date-selector-control {
            background-color: var(--cosmos-card-bg); backdrop-filter: blur(10px) saturate(120%);
            border: 1px solid var(--cosmos-border); padding: 1.2rem 1.5rem; border-radius: 0.75rem;
            box-shadow: 0 6px 25px var(--cosmos-shadow-strong), 0 0 8px var(--cosmos-shadow-soft-glow);
            margin-bottom: 2rem; display: flex; gap: 1rem; align-items: center; justify-content: center;
            animation: popInSmoothGastos 0.5s cubic-bezier(0.25, 0.8, 0.25, 1) backwards;
        }
        @keyframes popInSmoothGastos { 0% { opacity: 0; transform: scale(0.95); } 100% { opacity: 1; transform: scale(1); } }
        #page-gastos .date-selector-control label { font-family: var(--font-title); color: var(--cosmos-purple-secondary); font-size: 1.1em; }
        #page-gastos .date-selector-control input[type="month"] {
            padding: 0.8rem 1.2rem; background-color: var(--cosmos-input-bg); color: var(--cosmos-text-primary);
            border: 1px solid var(--cosmos-input-border); border-radius: 0.375rem; font-family: var(--font-body); font-size: 1.1em;
            min-width: 200px; color-scheme: dark; transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        #page-gastos .date-selector-control input[type="month"]:focus {
            outline: none; border-color: var(--cosmos-input-focus-border);
            box-shadow: 0 0 0 3px var(--cosmos-input-focus-shadow), 0 0 10px var(--cosmos-cyan-glow);
        }
        #page-gastos #gastosMesDetalhesContainer .secao { /* Adjusted ID */
            opacity: 0; transform: translateY(30px) scale(0.98); 
            animation: fadeInDetailSectionGastos 0.6s cubic-bezier(0.25, 0.8, 0.25, 1) forwards; 
            background-color: var(--cosmos-card-bg);
            backdrop-filter: blur(12px) saturate(130%); 
            border: 1px solid var(--cosmos-border);
            padding: 1.8rem 2rem; border-radius: 0.85rem;
            box-shadow: 0 8px 30px var(--cosmos-shadow-strong), inset 0 0 10px rgba(13,17,23,0.5), 0 0 10px var(--cosmos-shadow-soft-glow); 
            margin-bottom: 2.2rem;
        }
        @keyframes fadeInDetailSectionGastos { to { opacity: 1; transform: translateY(0) scale(1); } }
        #page-gastos .secao h2 {
            font-family: var(--font-title); color: var(--cosmos-text-primary); margin-bottom: 1.5rem; text-align: left; font-weight: 500; font-size: 1.8em;
            position: relative; padding-bottom: 0.6rem; border-bottom: 2px solid transparent;
        }
        #page-gastos .secao h2.sub-titulo-graficos {
            font-size: 1.5em; color: var(--cosmos-purple-secondary); margin-top: 2.5rem; margin-bottom: 1rem;
            text-align: center;
        }
        #page-gastos .secao h2.sub-titulo-graficos::after { display: none; }
        #page-gastos .secao h2::after {
            content: ''; position: absolute; bottom: -2px; left: 0; width: 0%; height: 2px;
            background: linear-gradient(90deg, var(--cosmos-cyan-accent), var(--cosmos-pink-accent), var(--cosmos-purple-primary));
            border-radius: 2px; transition: width 0.5s ease-in-out 0.1s; box-shadow: 0 0 8px var(--cosmos-cyan-accent);
        }
        #page-gastos #gastosMesDetalhesContainer .secao:hover h2:not(.sub-titulo-graficos)::after, /* Adjusted ID */
        #page-gastos .secao.visible h2:not(.sub-titulo-graficos)::after { width: 60%; }
        #page-gastos .cards-container { display: flex; flex-wrap: wrap; gap: 1.5rem; justify-content: space-around; margin-bottom: 2rem; }
        #page-gastos .card {
            background: linear-gradient(145deg, rgba(35,40,60,0.92), rgba(25,30,45,0.97)); border: 1px solid var(--cosmos-border);
            padding: 1.2rem 1.5rem; border-radius: 0.6rem; flex: 1 1 280px; min-width: 250px;
            box-shadow: 0 4px 18px var(--cosmos-shadow-strong), 0 0 8px var(--cosmos-shadow-soft-glow), inset 0 1px 2px rgba(13,17,23,0.4);
            transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease; position: relative; overflow: hidden;
        }
        #page-gastos .card::before {
            content: ""; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(106, 242, 240, 0.08), transparent);
            transition: left 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        #page-gastos .card:hover::before { left: 100%; }
        #page-gastos .card:hover {
            transform: translateY(-6px) scale(1.025); border-color: var(--cosmos-cyan-accent);
            box-shadow: 0 10px 30px var(--cosmos-shadow-strong), 0 0 20px var(--cosmos-cyan-glow), inset 0 1px 3px rgba(13,17,23,0.5);
        }
        #page-gastos .card h3 { font-family: var(--font-title); font-size: 1.0em; color: var(--cosmos-purple-secondary); font-weight: 500; margin-bottom: 0.5rem; }
        #page-gastos .card p { margin: 0.3rem 0; font-size: 1.4em; font-weight: 700; color: var(--cosmos-text-primary); }
        #page-gastos .card .subtext { font-size: 0.8em; font-weight: 400; color: var(--cosmos-text-secondary); opacity: 0.9; }
        #page-gastos .card .positivo { color: var(--cosmos-positive) !important; text-shadow: 0 0 6px var(--cosmos-positive); animation: pulsePositiveGastos 2s infinite alternate; }
        #page-gastos .card .negativo { color: var(--cosmos-negative) !important; text-shadow: 0 0 6px var(--cosmos-negative); animation: pulseNegativeGastos 2s infinite alternate; }
        @keyframes pulsePositiveGastos { from { opacity: 0.8; filter: brightness(0.9); } to { opacity: 1; filter: brightness(1.1); } }
        @keyframes pulseNegativeGastos { from { opacity: 0.8; filter: brightness(0.9); } to { opacity: 1; filter: brightness(1.1); } }
        #page-gastos .graficos-container { display: flex; flex-wrap: wrap; gap: 2rem; justify-content: space-around; margin-top: 1.5rem; margin-bottom: 2rem; }
        #page-gastos .grafico-card {
            background-color: var(--cosmos-card-bg); backdrop-filter: blur(8px); border: 1px solid var(--cosmos-border);
            padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 6px 20px var(--cosmos-shadow-strong), inset 0 0 5px rgba(13,17,23,0.3);
            flex: 1 1 400px; min-width: 300px; max-width: 550px; display: flex; flex-direction: column; align-items: center;
        }
        #page-gastos .grafico-card h4 { font-family: var(--font-title); color: var(--cosmos-cyan-accent); font-size: 1.2em; margin-bottom: 1rem; text-align: center; }
        #page-gastos .grafico-card canvas { max-width: 100%; max-height: 300px; }
        #page-gastos .grafico-placeholder { color: var(--cosmos-text-secondary); font-style: italic; text-align: center; padding: 2rem 0; }
        #page-gastos .table-wrapper { overflow-x: auto; }
        #page-gastos table {
            width: 100%; border-collapse: separate; border-spacing: 0; background-color: rgba(15, 18, 30, 0.85);
            border-radius: 0.75rem; overflow: hidden; box-shadow: 0 5px 20px var(--cosmos-shadow-strong);
            border: 1px solid var(--cosmos-border); margin-top: 1rem;
        }
        #page-gastos th {
            background-color: rgba(20, 25, 45, 0.9); color: var(--cosmos-cyan-accent); font-weight: 600; padding: 0.9rem 1.1rem;
            font-family: var(--font-title); border-bottom: 2px solid var(--cosmos-cyan-accent); white-space: nowrap;
            font-size: 0.9em; text-align: left; text-shadow: 0 0 4px var(--cosmos-cyan-accent);
        }
        #page-gastos td {
            padding: 0.8rem 1.1rem; border-bottom: 1px solid var(--cosmos-input-border); vertical-align: middle;
            font-size: 0.85em; color: var(--cosmos-text-secondary); transition: background-color 0.2s ease, color 0.2s ease;
        }
        #page-gastos tbody tr:last-child td { border-bottom: none; }
        #page-gastos tbody tr:nth-child(even) { background-color: rgba(20, 25, 45, 0.5); }
        #page-gastos tbody tr:hover { background-color: rgba(106, 242, 240, 0.07); }
        #page-gastos tbody tr:hover td { color: var(--cosmos-cyan-accent); }
        #page-gastos td.currency { text-align: right; }
        #page-gastos td.center-text { text-align: center; font-weight: bold; }
        #page-gastos td.positivo, #page-gastos tfoot td.positivo { color: var(--cosmos-positive) !important; font-weight: 600; text-shadow: 0 0 4px var(--cosmos-positive); }
        #page-gastos td.negativo, #page-gastos tfoot td.negativo { color: var(--cosmos-negative) !important; font-weight: 600; text-shadow: 0 0 4px var(--cosmos-negative); }
        #page-gastos tfoot td {
            font-weight: bold; color: var(--cosmos-text-primary); background-color: rgba(25, 30, 50, 0.9);
            padding: 1rem 1.1rem; font-size: 0.9em;
        }
        #page-gastos tfoot td:first-child { text-align: right; font-family: var(--font-title); color: var(--cosmos-purple-secondary); }
        #page-gastos .form-transacao { margin-top: 1.5rem; padding: 1.5rem; background-color: rgba(20,25,40,0.8); border-radius: 0.75rem; border: 1px solid var(--cosmos-border); box-shadow: 0 0 15px var(--cosmos-shadow-soft-glow); animation: popInSmoothGastosForm 0.5s 0.2s cubic-bezier(0.25, 0.8, 0.25, 1) backwards; }
        @keyframes popInSmoothGastosForm { 0% { opacity: 0; transform: scale(0.95); } 100% { opacity: 1; transform: scale(1); } }
        #page-gastos .form-transacao h3 { font-family: var(--font-title); color: var(--cosmos-purple-secondary); font-weight: 500; font-size: 1.3em; margin-bottom: 1.2rem; }
        #page-gastos .form-transacao .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.2rem; }
        #page-gastos .form-transacao .form-grid-full { grid-column: 1 / -1; }
        #page-gastos .form-transacao label { display: block; margin-bottom: 0.3rem; font-size: 0.9em; color: var(--cosmos-text-secondary); }
        #page-gastos .form-transacao input, #page-gastos .form-transacao select { width: 100%; padding: 0.7rem 0.9rem; border: 1px solid var(--cosmos-input-border); border-radius: 0.375rem; background-color: var(--cosmos-input-bg); color: var(--cosmos-text-primary); font-family: var(--font-body); font-size: 0.95em; transition: border-color 0.2s ease, box-shadow 0.2s ease; }
        #page-gastos .form-transacao input::placeholder { color: var(--cosmos-text-secondary); opacity: 0.7; }
        #page-gastos .form-transacao input:focus, #page-gastos .form-transacao select:focus { outline: none; border-color: var(--cosmos-input-focus-border); box-shadow: 0 0 0 3px var(--cosmos-input-focus-shadow), 0 0 8px var(--cosmos-cyan-glow); }
        #page-gastos .form-transacao .botoes-form { display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1rem; }
        #page-gastos .form-transacao button { border: none; padding: 0.7rem 1.5rem; border-radius: 0.375rem; cursor: pointer; font-weight: 600; font-size: 1em; font-family: var(--font-title); transition: all 0.25s ease-out; color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.25); box-shadow: 0 2px 5px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.05); }
        #page-gastos .form-transacao button.btn-registrar-recebido { background-image: linear-gradient(135deg, var(--cosmos-positive) 0%, #22c55e 100%); }
        #page-gastos .form-transacao button.btn-registrar-recebido:hover { background-image: linear-gradient(135deg, #16a34a 0%, var(--cosmos-cyan-accent) 100%); }
        #page-gastos .form-transacao button.btn-registrar-envio { background-image: linear-gradient(135deg, var(--cosmos-negative) 0%, var(--cosmos-pink-accent) 100%); }
        #page-gastos .form-transacao button.btn-registrar-envio:hover { background-image: linear-gradient(135deg, #ef4444 0%, #d946ef 100%); }
        #page-gastos .form-transacao button.btn-cancelar { background-color: var(--cosmos-button-cancel-bg); }
        #page-gastos .form-transacao button:hover { transform: translateY(-2px); box-shadow: 0 5px 12px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.08), 0 0 10px var(--cosmos-cyan-glow); }
        #page-gastos .acoes-tabela button { background: transparent; border: 1px solid transparent; color: var(--cosmos-text-secondary); padding: 0.3rem 0.6rem; margin: 0 0.2rem; border-radius: 0.25rem; cursor: pointer; font-size: 1.1em; transition: color 0.2s, border-color 0.2s, transform 0.2s; }
        #page-gastos .acoes-tabela button:hover { transform: scale(1.1); }
        #page-gastos .acoes-tabela .btn-editar-gasto:hover { color: var(--cosmos-button-edit-bg); border-color: var(--cosmos-button-edit-bg); } /* Renamed class */
        #page-gastos .acoes-tabela .btn-excluir-gasto:hover { color: var(--cosmos-button-delete-text); border-color: var(--cosmos-button-delete-text); } /* Renamed class */
        #page-gastos td.editing-row input { width: 95%; padding: 0.4rem; font-size: 0.95em; }
        #page-gastos td.editing-row select { width: 95%; padding: 0.4rem; font-size: 0.95em; }
        #page-gastos .placeholder-mes { text-align: center; padding: 3rem 1rem; font-size: 1.2em; color: var(--cosmos-text-secondary); font-family: var(--font-title); border: 2px dashed var(--cosmos-border); border-radius: 0.75rem; margin-top: 2rem; background-color: rgba(20,25,40,0.5); }
        #page-gastos .placeholder-mes span { font-size: 2em; display: block; margin-bottom: 0.5rem; animation: pulsePlaceholderIconGastos 2.5s infinite ease-in-out; }
        @keyframes pulsePlaceholderIconGastos { 0%, 100% { transform: scale(1); opacity: 0.7; } 50% { transform: scale(1.1); opacity: 1; } }
        #page-gastos .confirmation-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(13, 17, 23, 0.88);
            backdrop-filter: blur(8px) saturate(150%);
            display: none; 
            justify-content: center; align-items: center; z-index: 4000;
            opacity: 0; transition: opacity 0.35s cubic-bezier(0.25, 0.8, 0.25, 1);
            padding: 1rem;
        }
        #page-gastos .confirmation-modal-overlay.visible { display: flex; opacity: 1; }
        #page-gastos .confirmation-modal-content {
            background: linear-gradient(155deg, var(--cosmos-card-bg), rgba(20, 25, 45, 0.97));
            padding: 2rem 2.5rem; border-radius: 0.85rem;
            border: 1px solid var(--cosmos-border-hover);
            box-shadow: 0 12px 35px var(--cosmos-shadow-strong), 0 0 30px var(--cosmos-shadow-soft-glow), 0 0 15px var(--cosmos-cyan-glow);
            text-align: center; max-width: 480px; width: 100%;
            transform: translateY(20px) scale(0.95); opacity: 0;
            transition: transform 0.35s cubic-bezier(0.18, 0.89, 0.32, 1.28), opacity 0.3s ease-out;
        }
        #page-gastos .confirmation-modal-overlay.visible .confirmation-modal-content {
            transform: translateY(0) scale(1); opacity: 1;
            transition-delay: 0.05s;
        }
        #page-gastos .confirmation-modal-icon {
            font-size: 3em; margin-bottom: 1rem;
            display: inline-block;
            animation: pulsePlaceholderIconGastos 2.2s infinite ease-in-out, rocketTakeOffGastos 0.5s 0.1s ease-out forwards;
            color: var(--cosmos-cyan-accent);
            text-shadow: 0 0 10px var(--cosmos-cyan-glow);
        }
        @keyframes rocketTakeOffGastos {
            from { transform: translateY(10px) rotate(-5deg); opacity: 0.5; }
            to { transform: translateY(0) rotate(0deg); opacity: 1; }
        }
        #page-gastos .confirmation-modal-content h3 {
            font-family: var(--font-title); color: var(--cosmos-purple-secondary);
            font-size: 1.5em; margin-bottom: 0.8rem; font-weight: 600;
            text-shadow: 0 0 8px var(--cosmos-purple-secondary);
        }
        #page-gastos .confirmation-modal-content p {
            color: var(--cosmos-text-secondary); margin-bottom: 2rem; font-size: 1em;
            line-height: 1.6;
        }
        #page-gastos .confirmation-modal-actions { display: flex; gap: 1.2rem; justify-content: center; }
        #page-gastos .confirmation-modal-actions button {
            border: none; padding: 0.8rem 1.8rem; border-radius: 0.5rem; cursor: pointer;
            font-weight: 700; font-size: 0.95em; font-family: var(--font-title);
            transition: all 0.25s ease-out; color: #fff;
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
            box-shadow: 0 3px 7px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.08);
        }
        #page-gastos .confirmation-modal-actions button.btn-confirm {
            background-image: linear-gradient(135deg, var(--cosmos-negative) 0%, var(--cosmos-pink-accent) 100%);
        }
        #page-gastos .confirmation-modal-actions button.btn-confirm:hover {
            background-image: linear-gradient(135deg, #ef4444 0%, #d946ef 100%);
            transform: translateY(-3px) scale(1.03);
            box-shadow: 0 6px 15px rgba(236, 72, 153, 0.5), inset 0 1px 0 rgba(255,255,255,0.1);
        }
        #page-gastos .confirmation-modal-actions button.btn-cancel {
            background-color: var(--cosmos-button-cancel-bg);
            color: var(--cosmos-text-primary);
        }
        #page-gastos .confirmation-modal-actions button.btn-cancel:hover {
            background-color: #788190;
            transform: translateY(-3px) scale(1.03);
            box-shadow: 0 6px 15px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.1);
        }
        @media (max-width: 600px) {
             #page-gastos .confirmation-modal-content { padding: 1.5rem; }
             #page-gastos .confirmation-modal-icon { font-size: 2.5em; }
             #page-gastos .confirmation-modal-content h3 { font-size: 1.3em; }
             #page-gastos .confirmation-modal-content p { font-size: 0.9em; }
             #page-gastos .confirmation-modal-actions { flex-direction: column; gap: 0.8rem; }
             #page-gastos .confirmation-modal-actions button { width: 100%; padding: 0.7rem; font-size: 0.9em;}
        }
        /* End of terer.html styles */

        .hidden { display: none !important; }

    </style>
</head>
<body>
    <div id="starry-sky-backdrop"></div>
    <div id="loadingOverlay" class="loading-spinner-overlay"><div class="spinner"></div></div>
    <div id="notification-container"></div>

    <nav id="main-nav">
        <button data-page="patrimonio" class="active">Patrimônio Estelar</button>
        <button data-page="emprestimos">Empréstimos CosmoFin</button>
        <button data-page="gastos">Gastos Cósmicos</button>
    </nav>

    <main id="page-content-area">
        <!-- Page: Patrimônio -->
        <div id="page-patrimonio" class="page-view">
            <div class="container">
                <header>
                    <h1>Painel de Bordo: Patrimônio</h1>
                </header>
                <section class="secao destaques">
                    <h2>Telemetria Financeira</h2>
                    <div class="cards-container">
                        <div class="card" id="cardMetaPatrimonio">
                            <h3>Meta de Patrimônio Galáctico</h3>
                            <p>Meta: <span id="metaValorDisplay">R$ 0,00</span> <button id="definirMetaBtn" class="mini-btn" title="Definir Nova Meta">🎯</button></p>
                            <div class="progress-bar-meta-bg">
                                <div id="progressBarMetaFill" class="progress-bar-meta-fill" style="width: 0%;"></div>
                            </div>
                            <p class="subtext">Progresso: <span id="metaProgressoDisplay">0%</span> (<span id="metaRestanteDisplay" class="valor-card">R$ 0,00</span> restantes)</p>
                        </div>
                        <div class="card" id="cardDiaMaisForte"><h3>Pico de Sinal</h3><p>R$ <span id="diaMaisForteValor" class="valor-card">0.00</span></p><p class="subtext">Em: <span id="diaMaisForteData">-</span></p></div>
                        <div class="card" id="cardMaiorGanho">
                            <h3>Maior Pulso Positivo (Dia)</h3>
                            <p><span id="maiorGanhoValor" class="valor-card">R$ 0,00</span></p>
                            <p class="subtext">Em: <span id="maiorGanhoData">-</span></p>
                        </div>
                        <div class="card" id="cardMaiorPerda">
                            <h3>Maior Dreno de Energia (Dia)</h3>
                            <p><span id="maiorPerdaValor" class="valor-card">R$ 0,00</span></p>
                            <p class="subtext">Em: <span id="maiorPerdaData">-</span></p>
                        </div>
                         <div class="card" id="cardCrescimentoMarco"><h3>Pulso de Março</h3><p><span id="crescimentoMarco" class="valor-card">R$ 0.00</span></p><p class="subtext">(Ciclo: 2025)</p></div>
                        <div class="card" id="cardCrescimentoAbril"><h3>Pulso de Abril</h3><p><span id="crescimentoAbril" class="valor-card">R$ 0.00</span></p><p class="subtext">(Ciclo: 2025)</p></div>
                    </div>
                </section>
                <section class="secao grafico-patrimonio">
                    <h2>Trajetória de Ativos</h2>
                    <div id="patrimonioChartContainer"><canvas id="patrimonioChart"></canvas></div>
                </section>
                <section class="secao resumo-agregado">
                    <h2>Relatório de Flutuações Cósmicas</h2>
                    <div class="resumo-controles">
                        <label for="selectAnoResumo">Ano:</label>
                        <select id="selectAnoResumo"></select>
                        <label for="selectMesResumo">Mês (Opcional):</label>
                        <select id="selectMesResumo">
                            <option value="todos">Todos os Meses</option>
                        </select>
                    </div>
                    <div id="resumoAgregadoContainer">
                        <p class="placeholder-resumo">Selecione o período para análise.</p>
                    </div>
                </section>
                <section class="secao patrimonio-total">
                    <h2>Registros de Navegação Financeira</h2>
                    <div class="table-controls">
                        <button id="toggleEditModeBtn">Interface de Edição</button>
                        <button id="saveAllBtn" class="hidden">Confirmar Dados</button>
                        <button id="cancelEditBtn" class="hidden">Cancelar Edição</button>
                    </div>
                    <div id="addEntryForm">
                        <h3>Novo Registro de Log</h3>
                        <input type="date" id="newEntryDate" required>
                        <input type="text" id="newEntryComentario" placeholder="Descrição da Anomalia/Evento" required>
                        <input type="number" id="newEntryPatrimonio" placeholder="Unidades (Ex: 9000.50)" step="0.01" required>
                        <button id="addEntryBtn" class="save-btn"><span>Registrar</span></button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Data Estelar</th>
                                <th>Log de Evento</th>
                                <th>Saldo (Unidades)</th>
                                <th>Flutuação Diária</th>
                                <th class="edit-action-header hidden">Ejetar Log</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaPatrimonioBody"></tbody>
                    </table>
                </section>
            </div>
        </div>

        <!-- Page: Empréstimos -->
        <div id="page-emprestimos" class="page-view hidden">
             <div class="total-counter-wrapper">
                <div class="total-counter-container">
                    <div class="counter-main">
                        <span>Em Circulação:</span>
                        <span id="valorCirculacaoPrincipal">R$ 0,00</span>
                    </div>
                    <div class="counter-details">
                        <p><span>Total Girando:</span> <span id="totalGirando">R$ 0,00</span></p>
                        <p><span>Lucro a Receber:</span> <span id="valorLucroReceber">R$ 0,00</span></p>
                        <p><span>Média Juros(%):</span> <span id="valorMediaPorcentagem">0.00%</span></p>
                        <p><span>Lucro Realizado:</span> <span id="valorLucroRealizado">R$ 0,00</span></p>
                    </div>
                </div>
           </div>
            <main> 
                <section class="client-data">
                    <h2>Painel de emprestimos</h2>
                    <p>Gerencie seus emprestimos com precisão. Clique duas vezes para editar.</p>
                    <table>
                        <colgroup> <col> <col> <col> <col> <col> <col> <col> <col> <col> <col> </colgroup>
                        <thead>
                            <tr>
                                <th>ID</th> <th>cliente</th> <th>Valor Base</th> <th>juros (R$)</th>
                                <th>Taxa (%)</th> <th>Data</th> <th>validade</th> <th>total</th>
                                <th>Coletado?</th> <th>Comandos</th>
                            </tr>
                        </thead>
                        <tbody id="clientTableBody">
                        </tbody>
                    </table>
                    <button id="addClientBtn" class="action-button"><span>Novo emprestimo</span></button>
                </section>
                <section id="clientSummarySection" class="client-summary">
                     <h2>Relatório de Clientes (Valores Pendentes)</h2>
                    <div class="summary-content-wrapper">
                        <div id="clientSummaryList" class="client-summary-list">
                            <p class="summary-placeholder">Analisando constelações de dados...</p>
                        </div>
                        <div id="clientChartContainer" class="client-chart-container">
                            <canvas id="clientDebtChart"></canvas>
                            <p id="chartPlaceholder" class="chart-placeholder">Visualizando órbitas financeiras...</p>
                        </div>
                    </div>
                </section>
                <section id="financialAnalysisSection" class="financial-analysis">
                    <h2>Análise Financeira Geral</h2>
                    <div id="investmentLimitContainer" class="investment-limit-container">
                        <h3>Limite de Investimento</h3>
                        <div class="limit-details">
                            <span>Em Circulação: <strong id="circulacaoValor">R$ 0,00</strong></span>
                            <span>Limite Atual: <strong id="limiteValor">R$ 3.000,00</strong></span>
                            <span>Disponível:<strong id="disponivelValor" class="available">R$ 3.000,00</strong></span>
                        </div>
                        <div class="progress-bar-bg">
                            <div id="progressBarFill" class="progress-bar-fill" style="width: 0%;"></div>
                        </div>
                        <div class="progress-percentage" id="progressBarPercentage">0% Utilizado</div>
                    </div>
                    <div id="additionalChartsContainer" class="additional-charts-container">
                        <div class="chart-box">
                            <h4>Principal vs. Juros (Total Geral)</h4>
                            <div class="chart-wrapper">
                                <canvas id="profitMarginChart"></canvas>
                                <p id="profitMarginPlaceholder" class="chart-placeholder">Contando estrelas...</p>
                            </div>
                        </div>
                        <div class="chart-box">
                            <h4>Status dos Empréstimos (Contagem)</h4>
                             <div class="chart-wrapper">
                                <canvas id="loanStatusChart"></canvas>
                                <p id="loanStatusPlaceholder" class="chart-placeholder">Verificando logs...</p>
                            </div>
                        </div>
                    </div>
                </section>
                 <section id="cashFlowSection" class="cash-flow-analysis">
                    <h2>Histórico de Capital (Fluxo de Caixa)</h2>
                    <div class="chart-box">
                        <h4>Evolução do Capital Disponível</h4>
                         <div class="chart-wrapper">
                            <canvas id="cashFlowChart"></canvas>
                            <p id="cashFlowPlaceholder" class="chart-placeholder">Calculando trajetória temporal...</p>
                        </div>
                    </div>
                </section>
            </main>
            <div id="confirmDeleteOverlay" class="modal-overlay">
                 <div id="confirmDeleteModal" class="modal-container">
                    <h3 class="modal-title">🚨 Alerta de Buraco Negro! 🚨</h3>
                    <p class="modal-message">Tem certeza que deseja ejetar esta missão de crédito para o esquecimento? <br><strong>Esta ação é irreversível e alterará o continuum espaço-tempo financeiro!</strong></p>
                    <div class="modal-actions">
                        <button id="confirmDeleteBtn" class="modal-button modal-button-confirm">Sim, Ejetar!</button>
                        <button id="cancelDeleteBtn" class="modal-button modal-button-cancel">Cancelar Manobra</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page: Gastos -->
        <div id="page-gastos" class="page-view hidden">
            <div class="container">
                <header>
                    <h1>Controle de Gastos Cósmicos</h1>
                </header>
                <div class="date-selector-control">
                    <label for="gastosDatePickerMesAno">Analisar Mês/Ano:</label>
                    <input type="month" id="gastosDatePickerMesAno">
                </div>
                <div id="gastosMesDetalhesContainer">
                    <div class="placeholder-mes">
                        <span>🌠</span>
                        Selecione um mês/ano para análise intergaláctica de gastos.
                    </div>
                </div>
            </div>
            <div id="gastosConfirmationModalOverlay" class="confirmation-modal-overlay">
                <div class="confirmation-modal-content">
                    <div class="confirmation-modal-icon">🚀</div>
                    <h3 id="gastosConfirmationModalTitle">Confirmar Ação Cósmica</h3>
                    <p id="gastosConfirmationModalMessage">Você tem certeza?</p>
                    <div class="confirmation-modal-actions">
                        <button id="gastosConfirmModalButton" class="btn-confirm">Confirmar Ejeção</button>
                        <button id="gastosCancelModalButton" class="btn-cancel">Cancelar Manobra</button>
                    </div>
                </div>
            </div>
            <template id="gastosFormTransacaoTemplate">
                <form class="form-transacao">
                    <h3 id="gastosFormTransacaoTitulo">Adicionar Nova Transação Cósmica</h3>
                    <div class="form-grid">
                        <div><label for="gastosTransData">Data da Transação:</label><input type="date" id="gastosTransData" required></div>
                        <div><label for="gastosTransMotivo">Motivo/Descrição:</label><input type="text" id="gastosTransMotivo" placeholder="Ex: Compra de combustível de foguete" required></div>
                        <div><label for="gastosTransQuem">Quem/Origem/Destino:</label><input type="text" id="gastosTransQuem" placeholder="Ex: Estação Espacial Alfa" required></div>
                        <div><label for="gastosTransValor">Valor (R$):</label><input type="number" id="gastosTransValor" step="0.01" placeholder="Ex: 150.75" required></div>
                    </div>
                    <div class="botoes-form">
                        <button type="button" class="btn-cancelar" onclick="cancelarAdicaoEdicaoTransacaoGastos()">Cancelar</button>
                        <button type="button" class="btn-registrar-recebido">Entrada</button>
                        <button type="button" class="btn-registrar-envio">Saida</button>
                    </div>
                </form>
            </template>
        </div>
    </main>

    <script type="module">
            // --- Firebase Configurations and Initializations ---
      const firebaseConfigPatrimonio = {
        apiKey: "AIzaSyBguBmDJQmJ3RCoDrRjNwefZ1pwCPFzAnc",
        authDomain: "patrimonio-338c2.firebaseapp.com",
        databaseURL: "https://patrimonio-338c2-default-rtdb.firebaseio.com",
        projectId: "patrimonio-338c2",
        storageBucket: "patrimonio-338c2.firebasestorage.app",
        messagingSenderId: "552492772905",
        appId: "1:552492772905:web:7352ab0f441f8046a47638",
        measurementId: "G-EMYN0EQYD8"
      };

      const firebaseConfigEmprestimos = {
        apiKey: "AIzaSyBYYvRNDdXD6ILYYzXZK5l6hQoLk7Ikrbs",
        authDomain: "projeto-financeiro-84c65.firebaseapp.com",
        databaseURL: "https://projeto-financeiro-84c65-default-rtdb.firebaseio.com",
        projectId: "projeto-financeiro-84c65",
        storageBucket: "projeto-financeiro-84c65.firebasestorage.app",
        messagingSenderId: "290551393578",
        appId: "1:290551393578:web:b0e5898d441360f5af4253"
      };

      const firebaseConfigGastos = {
        apiKey: "AIzaSyBVrRGEqr8t8dD8ikEcguuyu1rb9yPHB3o",
        authDomain: "controle-de-gastos-c41d6.firebaseapp.com",
        databaseURL: "https://controle-de-gastos-c41d6-default-rtdb.firebaseio.com",
        projectId: "controle-de-gastos-c41d6",
        storageBucket: "controle-de-gastos-c41d6.firebasestorage.app",
        messagingSenderId: "470879933809",
        appId: "1:470879933809:web:6fc9642396cdcf4b46d2d0",
        measurementId: "G-4W5D5KL09M"
      };
      
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
      import { getDatabase, ref, get, set, update, push, remove, onValue, child } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

      // Initialize Firebase Apps with unique names
      const appPatrimonio = initializeApp(firebaseConfigPatrimonio, 'patrimonioApp');
      const databasePatrimonio = getDatabase(appPatrimonio);

      const appEmprestimos = initializeApp(firebaseConfigEmprestimos, 'emprestimosApp');
      const databaseEmprestimos = getDatabase(appEmprestimos);

      const appGastos = initializeApp(firebaseConfigGastos, 'gastosApp');
      const databaseGastos = getDatabase(appGastos);
      
      // Store common DB functions globally
      window.firebaseDbFunctions = { ref, get, set, update, push, remove, onValue, child };

      const loadingOverlayGlobalEl = document.getElementById('loadingOverlay');
      function showGlobalLoading() { if(loadingOverlayGlobalEl) loadingOverlayGlobalEl.classList.add('visible'); }
      function hideGlobalLoading() { if(loadingOverlayGlobalEl) loadingOverlayGlobalEl.classList.remove('visible'); }

      function showGlobalNotification(message, type = 'info', duration = 5000) {
          const container = document.getElementById('notification-container');
          if (!container) {
              console.error("Global Notification container not found!");
              window.alert(`${type.toUpperCase()}: ${message}`);
              return;
          }
          const notification = document.createElement('div');
          notification.classList.add('notification-popup', type);
          const iconSpan = document.createElement('span');
          iconSpan.classList.add('icon');
          let iconChar = '';
          switch (type) {
              case 'success': iconChar = '✔️'; break;
              case 'error':   iconChar = '❌'; break;
              case 'warning': iconChar = '⚠️'; break;
              case 'info':    iconChar = 'ℹ️'; break;
          }
          iconSpan.textContent = iconChar;
          const messageSpan = document.createElement('span');
          messageSpan.textContent = message;
          notification.appendChild(iconSpan);
          notification.appendChild(messageSpan);
          container.prepend(notification);
          requestAnimationFrame(() => {
              requestAnimationFrame(() => { notification.classList.add('show'); });
          });
          let timerId = setTimeout(() => dismissNotification(), duration);
          const dismissNotification = () => {
              notification.classList.remove('show');
              const handleTransitionEnd = () => {
                  notification.removeEventListener('transitionend', handleTransitionEnd);
                  if (notification.parentElement) notification.remove();
              };
              notification.addEventListener('transitionend', handleTransitionEnd);
              setTimeout(() => { if (notification.parentElement) notification.remove(); }, 500);
          };
          notification.addEventListener('click', () => {
              clearTimeout(timerId);
              dismissNotification();
          });
      }
      window.showNotification = showGlobalNotification; 

      const pageViews = document.querySelectorAll('.page-view');
      const navButtons = document.querySelectorAll('#main-nav button');
      const initializedPages = {}; 

      function showPage(pageIdToShow) {
          pageViews.forEach(view => {
              view.classList.add('hidden');
          });
          navButtons.forEach(btn => btn.classList.remove('active'));

          const activeView = document.getElementById(pageIdToShow);
          const activeButton = document.querySelector(`#main-nav button[data-page="${pageIdToShow.replace('page-','')}"]`);

          if (activeView) activeView.classList.remove('hidden');
          if (activeButton) activeButton.classList.add('active');

          if (!initializedPages[pageIdToShow]) {
              console.log(`Initializing page: ${pageIdToShow}`);
              if (pageIdToShow === 'page-patrimonio' && typeof initPatrimonioPage === 'function') initPatrimonioPage();
              else if (pageIdToShow === 'page-emprestimos' && typeof initEmprestimosPage === 'function') initEmprestimosPage();
              else if (pageIdToShow === 'page-gastos' && typeof initGastosPage === 'function') initGastosPage();
              initializedPages[pageIdToShow] = true;
          } else {
            console.log(`Page ${pageIdToShow} already initialized.`);
            if (pageIdToShow === 'page-emprestimos' && typeof refreshEmprestimosPage === 'function') {
                refreshEmprestimosPage(); 
            }
            // Add refresh logic for other pages if needed
            if (pageIdToShow === 'page-patrimonio' && typeof refreshPatrimonioPage === 'function') {
                refreshPatrimonioPage();
            }
             if (pageIdToShow === 'page-gastos' && typeof refreshGastosPage === 'function') {
                refreshGastosPage();
            }
          }
           window.scrollTo(0, 0); // Scroll to top when changing pages
      }

      navButtons.forEach(button => {
          button.addEventListener('click', () => {
              const pageId = `page-${button.dataset.page}`;
              showPage(pageId);
          });
      });

      // --- Patrimonio Page Script ---
      function initPatrimonioPage() {
        const database = databasePatrimonio; // USE PATRIMONIO'S DB INSTANCE
        const { ref, get, set, update, push, remove, onValue, child } = window.firebaseDbFunctions;
        const patrimonioView = document.getElementById('page-patrimonio');
        const LOCAL_STORAGE_KEY_META = 'patrimonioMetaCosmosV4FirebaseUnified'; // Unique key
        const patrimonioRef = ref(database, 'patrimonioEstelar/registros'); 
        const metaDbRef = ref(database, 'patrimonioEstelar/meta'); 
        let dadosPatrimonio = [];
        let nextId = 1;
        let patrimonioChartInstance;
        let isEditMode = false;
        let metaPatrimonio = 50000;
        const metaValorDisplayEl = patrimonioView.querySelector('#metaValorDisplay');
        const definirMetaBtn = patrimonioView.querySelector('#definirMetaBtn');
        const progressBarMetaFillEl = patrimonioView.querySelector('#progressBarMetaFill');
        const metaProgressoDisplayEl = patrimonioView.querySelector('#metaProgressoDisplay');
        const metaRestanteDisplayEl = patrimonioView.querySelector('#metaRestanteDisplay');
        const maiorGanhoValorEl = patrimonioView.querySelector('#maiorGanhoValor');
        const maiorGanhoDataEl = patrimonioView.querySelector('#maiorGanhoData');
        const maiorPerdaValorEl = patrimonioView.querySelector('#maiorPerdaValor');
        const maiorPerdaDataEl = patrimonioView.querySelector('#maiorPerdaData');
        const selectAnoResumoEl = patrimonioView.querySelector('#selectAnoResumo');
        const selectMesResumoEl = patrimonioView.querySelector('#selectMesResumo');
        const resumoAgregadoContainerEl = patrimonioView.querySelector('#resumoAgregadoContainer');
        const addEntryBtn = patrimonioView.querySelector('#addEntryBtn');
        const toggleEditModeBtnEl = patrimonioView.querySelector('#toggleEditModeBtn');
        const saveAllBtnEl = patrimonioView.querySelector('#saveAllBtn');
        const cancelEditBtnEl = patrimonioView.querySelector('#cancelEditBtn');
        const editActionHeaderEl = patrimonioView.querySelector('.edit-action-header');
        const addEntryFormEl = patrimonioView.querySelector('#addEntryForm');

        function formatarDataParaEixoX(dISO) { if (!dISO) return null; return new Date(dISO + 'T00:00:00Z').getTime(); }
        function formatarDataCompletaParaExibicao(dISO) {
             if (!dISO) return "-";
             try {
                const dateObj = new Date(dISO + 'T00:00:00Z');
                if (isNaN(dateObj.getTime())) return "Data Inválida";
                return dateObj.toLocaleDateString('pt-BR', {timeZone: 'UTC'});
             } catch (e) { return "Data Inválida"; }
        }
        function formatarMoeda(v) { return v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); }
        function calcularVariacaoDiaria(atual, anterior) { if (!anterior || anterior.patrimonio === undefined) return ""; if (atual.patrimonio > anterior.patrimonio) return "↑ Positivo"; if (atual.patrimonio < anterior.patrimonio) return "↓ Negativo"; return "Neutro"; }

        async function carregarMetaDoFirebase() { /* ... (implementation from previous response, no changes needed if paths are good) ... */ 
            try {
                const snapshot = await get(metaDbRef);
                if (snapshot.exists() && typeof snapshot.val() === 'number') {
                    metaPatrimonio = snapshot.val();
                } else {
                    metaPatrimonio = parseFloat(localStorage.getItem(LOCAL_STORAGE_KEY_META)) || 50000;
                    await set(metaDbRef, metaPatrimonio);
                }
            } catch (error) {
                console.error("Erro ao carregar meta do Firebase (Patrimônio):", error);
                showGlobalNotification("Falha ao carregar meta da base estelar. Usando valor local.", "warning");
                metaPatrimonio = parseFloat(localStorage.getItem(LOCAL_STORAGE_KEY_META)) || 50000;
            }
            atualizarDisplayMeta();
            atualizarGraficoPatrimonio();
        }
        async function salvarMetaNoFirebase(novaMeta) { /* ... (implementation from previous response) ... */ 
            try {
                await set(metaDbRef, novaMeta);
                metaPatrimonio = novaMeta;
                localStorage.setItem(LOCAL_STORAGE_KEY_META, novaMeta.toString());
                atualizarDisplayMeta();
                atualizarGraficoPatrimonio();
                showGlobalNotification("Nova meta salva com sucesso na base estelar!", "success");
            } catch (error) {
                console.error("Erro ao salvar meta no Firebase (Patrimônio):", error);
                showGlobalNotification("Falha ao salvar nova meta na base estelar.", "error");
            }
        }
        if (definirMetaBtn) definirMetaBtn.addEventListener('click', () => { /* ... (implementation from previous response, ensure prompt/alert use global if needed) ... */ 
            const novoValorMetaStr = prompt("Defina sua nova meta de patrimônio galáctico:", metaPatrimonio > 0 ? metaPatrimonio.toString().replace('.',',') : "100000");
            if (novoValorMetaStr !== null) {
                const novoValorMeta = parseFloat(novoValorMetaStr.replace(/\./g, '').replace(',', '.'));
                if (!isNaN(novoValorMeta) && novoValorMeta >= 0) {
                    salvarMetaNoFirebase(novoValorMeta);
                } else { 
                    showGlobalNotification("Valor da meta inválido. Por favor, insira um número válido.", "warning");
                }
            }
        });
        if (toggleEditModeBtnEl) toggleEditModeBtnEl.addEventListener('click', () => { /* ... (implementation from previous response) ... */ 
            isEditMode = true;
            toggleEditModeBtnEl.classList.add('hidden');
            saveAllBtnEl.classList.remove('hidden');
            cancelEditBtnEl.classList.remove('hidden');
            if(editActionHeaderEl) editActionHeaderEl.classList.remove('hidden');
            addEntryFormEl.classList.add('hidden');
            renderizarTabelaPatrimonio();
            showGlobalNotification("Interface de Edição Ativada. Modifique os registros e clique em 'Confirmar Dados'.", "info");
        });
        if (cancelEditBtnEl) cancelEditBtnEl.addEventListener('click', async () => { /* ... (implementation from previous response) ... */ 
            isEditMode = false;
            toggleEditModeBtnEl.classList.remove('hidden');
            saveAllBtnEl.classList.add('hidden');
            cancelEditBtnEl.classList.add('hidden');
            if(editActionHeaderEl) editActionHeaderEl.classList.add('hidden');
            addEntryFormEl.classList.remove('hidden');
            // Re-fetch or re-render from local cache to discard changes
            await onValue(patrimonioRef, (snapshot) => { // Re-trigger data processing
                 if (snapshot.exists()) {
                    const dadosDoFirebase = snapshot.val();
                    dadosPatrimonio = Object.keys(dadosDoFirebase).map(key => ({ firebaseId: key, ...dadosDoFirebase[key] }));
                    nextId = dadosPatrimonio.length > 0 ? (Math.max(0, ...dadosPatrimonio.map(d => d.id || 0)) + 1) : 1;
                } else {
                    dadosPatrimonio = []; nextId = 1;
                }
                renderizarTabelaPatrimonio();
            }, { onlyOnce: true }); // Fetch once to reset
            showGlobalNotification("Edição cancelada. Alterações não salvas foram descartadas.", "info");
        });
        if (saveAllBtnEl) saveAllBtnEl.addEventListener('click', async () => { /* ... (implementation from previous response, ensure notifications are global) ... */ 
            showGlobalLoading();
            const tabelaBody = patrimonioView.querySelector('#tabelaPatrimonioBody');
            const inputsParaSalvar = [];
            let valid = true;

            tabelaBody.querySelectorAll('tr.editing-row').forEach(row => {
                const firebaseId = row.dataset.firebaseId;
                const idLocal = parseInt(row.dataset.id);
                const dataInput = row.cells[0].querySelector('input');
                const comentarioInput = row.cells[1].querySelector('input');
                const patrimonioInput = row.cells[2].querySelector('input');

                if (!dataInput || !comentarioInput || !patrimonioInput) return;

                const data = dataInput.value;
                const comentario = comentarioInput.value.trim();
                const patrimonio = parseFloat(patrimonioInput.value);

                if (!data || data.length !== 10 || comentario === '' || isNaN(patrimonio)) {
                    valid = false;
                    [dataInput, comentarioInput, patrimonioInput].forEach(inp => inp.style.borderColor = 'var(--cosmos-negative)');
                } else {
                    [dataInput, comentarioInput, patrimonioInput].forEach(inp => inp.style.borderColor = '');
                    inputsParaSalvar.push({ firebaseId, idLocal, data, comentario, patrimonio });
                }
            });

            if (!valid) {
                showGlobalNotification("Corrija os campos com erro (borda vermelha) antes de salvar.", "warning");
                hideGlobalLoading();
                return;
            }

            const promessasDeAtualizacao = [];
            const idsVisuaisFirebase = new Set(inputsParaSalvar.map(item => item.firebaseId));
            const dadosPatrimonioAtuais = [...dadosPatrimonio]; // Cópia para evitar problemas com onValue

            dadosPatrimonioAtuais.forEach(itemOriginal => {
                if (itemOriginal.firebaseId && !idsVisuaisFirebase.has(itemOriginal.firebaseId)) {
                    promessasDeAtualizacao.push(excluirEntradaDoFirebasePatrimonio(itemOriginal.firebaseId));
                }
            });
            
            inputsParaSalvar.forEach(itemEditado => {
                const itemOriginal = dadosPatrimonioAtuais.find(d => d.firebaseId === itemEditado.firebaseId);
                if (itemOriginal) {
                    const dadosParaFirebase = { 
                        data: itemEditado.data,
                        comentario: itemEditado.comentario,
                        patrimonio: itemEditado.patrimonio,
                        id: itemOriginal.id 
                    };
                    if (itemOriginal.data !== dadosParaFirebase.data ||
                        itemOriginal.comentario !== dadosParaFirebase.comentario ||
                        itemOriginal.patrimonio !== dadosParaFirebase.patrimonio) {
                        promessasDeAtualizacao.push(atualizarEntradaNoFirebasePatrimonio(itemEditado.firebaseId, dadosParaFirebase));
                    }
                }
            });

            try {
                await Promise.all(promessasDeAtualizacao);
                showGlobalNotification("Transmissão de dados confirmada e processada no Firebase!", "success");
            } catch (error) {
                console.error("Erro ao salvar todas as alterações no Firebase (Patrimônio):", error);
                showGlobalNotification("Ocorreu um erro durante a sincronização com a base estelar.", "error");
            } finally {
                isEditMode = false;
                toggleEditModeBtnEl.classList.remove('hidden');
                saveAllBtnEl.classList.add('hidden');
                cancelEditBtnEl.classList.add('hidden');
                if(editActionHeaderEl) editActionHeaderEl.classList.add('hidden');
                addEntryFormEl.classList.remove('hidden');
                hideGlobalLoading();
            }
        });
        async function adicionarEntradaNoFirebasePatrimonio(novaEntrada) { /* ... (implementation from previous response) ... */ 
            showGlobalLoading();
            try {
                const entradaCompletaParaSalvar = { ...novaEntrada }; 
                const novoRegistroRef = push(patrimonioRef); 
                await set(novoRegistroRef, entradaCompletaParaSalvar);
                showGlobalNotification("Novo registro de log enviado para a base estelar!", "success");
            } catch (error) {
                console.error("Erro ao adicionar entrada no Firebase (Patrimônio):", error);
                showGlobalNotification("Falha ao registrar log na base estelar. Tente novamente.", "error");
            } finally {
                hideGlobalLoading();
            }
        }
        async function atualizarEntradaNoFirebasePatrimonio(idFirebase, dadosAtualizados) { /* ... (implementation from previous response) ... */ 
             try {
                const entradaRef = child(patrimonioRef, idFirebase);
                await update(entradaRef, dadosAtualizados);
            } catch (error) {
                console.error(`Erro ao atualizar entrada ${idFirebase} no Firebase (Patrimônio):`, error);
                throw error; 
            }
        }
        async function excluirEntradaDoFirebasePatrimonio(idFirebase) { /* ... (implementation from previous response) ... */ 
            try {
                const entradaRef = child(patrimonioRef, idFirebase);
                await remove(entradaRef);
            } catch (error){
                console.error(`Erro ao excluir entrada ${idFirebase} no Firebase (Patrimônio):`, error);
                throw error; 
            }
        }
        function excluirEntradaDaLinhaNaEdicaoPatrimonio(idLocal) { /* ... (implementation from previous response, ensure querySelector is scoped) ... */ 
            if (!isEditMode) return;
            const row = patrimonioView.querySelector(`#tabelaPatrimonioBody tr[data-id='${idLocal}']`);
            if (row) {
                row.remove();
                showGlobalNotification("Registro ejetado da interface. Salve para confirmar a exclusão.", "info", 3000);
            } else {
                console.warn(`Não foi possível encontrar a linha para excluir com ID local: ${idLocal}`);
            }
        }
        function renderizarTabelaPatrimonio() { /* ... (implementation from previous response, ensure querySelector is scoped and uses correct ID for delete button) ... */ 
            const tabelaBody = patrimonioView.querySelector('#tabelaPatrimonioBody');
            if (!tabelaBody) return;
            tabelaBody.innerHTML = '';
            
            const dadosOrdenados = [...dadosPatrimonio].sort((a, b) => new Date(a.data + 'T00:00:00Z') - new Date(b.data + 'T00:00:00Z'));

            dadosOrdenados.forEach((item, index) => {
                const itemAnterior = index > 0 ? dadosOrdenados[index - 1] : null;
                const variacao = calcularVariacaoDiaria(item, itemAnterior);
                const row = tabelaBody.insertRow();
                
                row.dataset.id = item.id; 
                if(item.firebaseId) row.dataset.firebaseId = item.firebaseId; 

                if (isEditMode && item.firebaseId) { 
                    row.classList.add('editing-row');
                    row.insertCell().innerHTML = `<input type="date" value="${item.data}">`;
                    row.insertCell().innerHTML = `<input type="text" value="${item.comentario}">`;
                    row.insertCell().innerHTML = `<input type="number" step="0.01" value="${item.patrimonio}">`;
                    const cellVariacaoEdit = row.insertCell();
                    cellVariacaoEdit.textContent = variacao;
                    cellVariacaoEdit.className = '';
                    if (variacao.includes("Positivo")) cellVariacaoEdit.classList.add('positivo');
                    else if (variacao.includes("Negativo")) cellVariacaoEdit.classList.add('negativo');

                    const deleteCell = row.insertCell();
                    const deleteButton = document.createElement('button');
                    deleteButton.className = 'row-delete-btn';
                    deleteButton.textContent = 'Ejetar'; 
                    deleteButton.onclick = () => excluirEntradaDaLinhaNaEdicaoPatrimonio(item.id); 
                    deleteCell.appendChild(deleteButton);
                } else {
                    row.classList.remove('editing-row');
                    row.insertCell().textContent = formatarDataCompletaParaExibicao(item.data);
                    row.insertCell().textContent = item.comentario;
                    row.insertCell().textContent = formatarMoeda(item.patrimonio);
                    const cellVariacao = row.insertCell();
                    cellVariacao.textContent = variacao;
                    cellVariacao.className = '';
                    if (variacao.includes("Positivo")) cellVariacao.classList.add('positivo');
                    else if (variacao.includes("Negativo")) cellVariacao.classList.add('negativo');
                    if (editActionHeaderEl && !editActionHeaderEl.classList.contains('hidden')) {
                         row.insertCell(); 
                    }
                }
            });
            atualizarCardsResumoPatrimonio();
            atualizarGraficoPatrimonio();
            popularFiltrosResumoPatrimonio();
            renderizarResumoAgregadoPatrimonio();
        }
        if (addEntryBtn) addEntryBtn.addEventListener('click', () => { /* ... (implementation from previous response) ... */ 
            showGlobalLoading();
            setTimeout(async () => { 
                const dataInput = patrimonioView.querySelector('#newEntryDate');
                const comentarioInput = patrimonioView.querySelector('#newEntryComentario');
                const patrimonioInput = patrimonioView.querySelector('#newEntryPatrimonio');
                const data = dataInput.value; 
                const comentario = comentarioInput.value.trim(); 
                const patrimonio = parseFloat(patrimonioInput.value);
                if (!data || data.length !== 10 || comentario === '' || isNaN(patrimonio)) { 
                    showGlobalNotification("Preencha todos os campos do log corretamente (Data: AAAA-MM-DD).", "warning");
                    hideGlobalLoading(); 
                    return; 
                }
                
                const novaEntradaObjeto = { 
                    id: nextId++, 
                    data, 
                    comentario, 
                    patrimonio 
                };
                
                dataInput.value = ''; comentarioInput.value = ''; patrimonioInput.value = '';
                await adicionarEntradaNoFirebasePatrimonio(novaEntradaObjeto); 
                hideGlobalLoading();
            }, 200);
        });
        function atualizarDisplayMeta() { /* ... (implementation from previous response, ensure querySelectors are scoped if elements are not global) ... */ 
             if (!metaValorDisplayEl || !progressBarMetaFillEl || !metaProgressoDisplayEl || !metaRestanteDisplayEl) return;
            metaValorDisplayEl.textContent = formatarMoeda(metaPatrimonio);
            if (metaPatrimonio > 0 && dadosPatrimonio.length > 0) {
                const dadosOrdenados = [...dadosPatrimonio].sort((a, b) => new Date(a.data + 'T00:00:00Z') - new Date(b.data + 'T00:00:00Z'));
                const patrimonioAtual = dadosOrdenados.length > 0 ? dadosOrdenados[dadosOrdenados.length -1].patrimonio : 0;

                const progresso = Math.min(100, (patrimonioAtual / metaPatrimonio) * 100);
                const restante = Math.max(0, metaPatrimonio - patrimonioAtual);
                progressBarMetaFillEl.style.width = `${progresso.toFixed(2)}%`;
                metaProgressoDisplayEl.textContent = `${progresso.toFixed(2)}%`;
                metaRestanteDisplayEl.textContent = `${formatarMoeda(restante)} restantes`;
                if (progresso >= 100) {
                    progressBarMetaFillEl.style.backgroundImage = `linear-gradient(90deg, var(--cosmos-positive), var(--cosmos-cyan-accent), #FFD700, var(--cosmos-pink-accent))`;
                    const existingEasterEgg = metaRestanteDisplayEl.parentElement.querySelector('.easter-egg-msg');
                    if (!existingEasterEgg && metaPatrimonio >= 100000 && patrimonioAtual >= metaPatrimonio) {
                        const easterEggEl = document.createElement('p');
                        easterEggEl.className = 'easter-egg-msg';
                        easterEggEl.textContent = "🌌 Bravo, Comandante! Você alcançou uma órbita lendária! 🌠";
                        easterEggEl.style.color = "var(--cosmos-cyan-accent)";
                        easterEggEl.style.textAlign = "center";
                        easterEggEl.style.marginTop = "0.5rem";
                        easterEggEl.style.fontSize = "0.9em";
                        metaRestanteDisplayEl.parentElement.appendChild(easterEggEl);
                        showGlobalNotification("Órbita Lendária alcançada! Parabéns, Comandante! 🌠", "success", 10000);
                        setTimeout(() => easterEggEl.remove(), 10000);
                    }
                } else {
                    progressBarMetaFillEl.style.backgroundImage = `linear-gradient(90deg, var(--cosmos-positive), var(--cosmos-cyan-accent))`;
                    const existingEasterEgg = metaRestanteDisplayEl.parentElement.querySelector('.easter-egg-msg');
                    if(existingEasterEgg) existingEasterEgg.remove();
                }

            } else {
                progressBarMetaFillEl.style.width = '0%';
                metaProgressoDisplayEl.textContent = '0%';
                metaRestanteDisplayEl.textContent = `${formatarMoeda(metaPatrimonio)} restantes`;
                progressBarMetaFillEl.style.backgroundImage = `linear-gradient(90deg, var(--cosmos-positive), var(--cosmos-cyan-accent))`;
                const existingEasterEgg = metaRestanteDisplayEl.parentElement.querySelector('.easter-egg-msg');
                if(existingEasterEgg) existingEasterEgg.remove();
            }
        }
        function calcularMaiorVariacaoDiariaPatrimonio() { /* ... (implementation from previous response) ... */ 
             if (!maiorGanhoValorEl || !maiorGanhoDataEl || !maiorPerdaValorEl || !maiorPerdaDataEl) return;
            if (dadosPatrimonio.length < 2) {
                maiorGanhoValorEl.textContent = formatarMoeda(0); maiorGanhoDataEl.textContent = "-";
                maiorPerdaValorEl.textContent = formatarMoeda(0); maiorPerdaDataEl.textContent = "-";
                return;
            }
            let maiorGanho = 0; let dataMaiorGanho = "-"; let maiorPerda = 0; let dataMaiorPerda = "-";
            const dadosOrdenados = [...dadosPatrimonio].sort((a, b) => new Date(a.data + 'T00:00:00Z') - new Date(b.data + 'T00:00:00Z'));
            for (let i = 1; i < dadosOrdenados.length; i++) {
                const variacao = dadosOrdenados[i].patrimonio - dadosOrdenados[i-1].patrimonio;
                if (variacao > maiorGanho) { maiorGanho = variacao; dataMaiorGanho = formatarDataCompletaParaExibicao(dadosOrdenados[i].data); }
                if (variacao < maiorPerda) { maiorPerda = variacao; dataMaiorPerda = formatarDataCompletaParaExibicao(dadosOrdenados[i].data); }
            }
            maiorGanhoValorEl.textContent = formatarMoeda(maiorGanho); maiorGanhoDataEl.textContent = dataMaiorGanho;
            maiorPerdaValorEl.innerHTML = `<span class="${maiorPerda < 0 ? 'negativo' : ''}">${formatarMoeda(Math.abs(maiorPerda))}</span>`;
            maiorPerdaDataEl.textContent = dataMaiorPerda;
        }
        function popularFiltrosResumoPatrimonio() { /* ... (implementation from previous response) ... */ 
             if (!selectAnoResumoEl || !selectMesResumoEl) return;
            const anos = [...new Set(dadosPatrimonio.map(d => d.data.substring(0, 4)))].sort((a,b) => b-a);
            const anoSelecionadoAntes = selectAnoResumoEl.value;
            selectAnoResumoEl.innerHTML = '<option value="">Selecione o Ano</option>';
            anos.forEach(ano => { const option = document.createElement('option'); option.value = ano; option.textContent = ano; selectAnoResumoEl.appendChild(option); });
            if(anos.includes(anoSelecionadoAntes)) selectAnoResumoEl.value = anoSelecionadoAntes;

            const mesesNomes = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            const mesSelecionadoAntes = selectMesResumoEl.value;
            selectMesResumoEl.innerHTML = '<option value="todos">Todos os Meses</option>';
            mesesNomes.forEach((nome, index) => { const option = document.createElement('option'); option.value = String(index + 1).padStart(2, '0'); option.textContent = nome; selectMesResumoEl.appendChild(option); });
            selectMesResumoEl.value = mesSelecionadoAntes;

            if (!selectAnoResumoEl.dataset.listenerAttachedPatrimonio) {
                selectAnoResumoEl.addEventListener('change', renderizarResumoAgregadoPatrimonio);
                selectAnoResumoEl.dataset.listenerAttachedPatrimonio = 'true';
            }
            if (!selectMesResumoEl.dataset.listenerAttachedPatrimonio) {
                selectMesResumoEl.addEventListener('change', renderizarResumoAgregadoPatrimonio);
                selectMesResumoEl.dataset.listenerAttachedPatrimonio = 'true';
            }
        }
        function renderizarResumoAgregadoPatrimonio() { /* ... (implementation from previous response) ... */ 
            if (!resumoAgregadoContainerEl || !selectAnoResumoEl || !selectMesResumoEl) return;
            const anoSelecionado = selectAnoResumoEl.value;
            const mesSelecionado = selectMesResumoEl.value;
            resumoAgregadoContainerEl.innerHTML = '';
            if (!anoSelecionado) { resumoAgregadoContainerEl.innerHTML = '<p class="placeholder-resumo">Selecione um ano para análise.</p>'; return; }

            let dadosFiltrados = dadosPatrimonio.filter(d => d.data.startsWith(anoSelecionado));
            if (mesSelecionado !== "todos") { dadosFiltrados = dadosFiltrados.filter(d => d.data.startsWith(`${anoSelecionado}-${mesSelecionado}`)); }
            if (dadosFiltrados.length === 0) { resumoAgregadoContainerEl.innerHTML = '<p class="placeholder-resumo">Nenhum registro para este período.</p>'; return; }
            
            dadosFiltrados.sort((a, b) => new Date(a.data + 'T00:00:00Z') - new Date(b.data + 'T00:00:00Z'));
            const patrimonioInicialPeriodo = dadosFiltrados[0].patrimonio;
            const patrimonioFinalPeriodo = dadosFiltrados[dadosFiltrados.length - 1].patrimonio;
            const variacaoTotal = patrimonioFinalPeriodo - patrimonioInicialPeriodo;
            const variacaoPercentual = patrimonioInicialPeriodo !== 0 ? (variacaoTotal / Math.abs(patrimonioInicialPeriodo)) * 100 : (variacaoTotal !== 0 ? (variacaoTotal > 0 ? Infinity : -Infinity) : 0);

            const divResumo = document.createElement('div'); divResumo.classList.add('resumo-item');
            let tituloPeriodo = `Ano de ${anoSelecionado}`;
            if (mesSelecionado !== "todos") { const nomeMes = selectMesResumoEl.options[selectMesResumoEl.selectedIndex]?.text || `Mês ${mesSelecionado}`; tituloPeriodo = `${nomeMes} de ${anoSelecionado}`; }
            divResumo.innerHTML = `
                <h4>Resumo: ${tituloPeriodo}</h4>
                <p>Patrimônio Inicial: <strong>${formatarMoeda(patrimonioInicialPeriodo)}</strong></p>
                <p>Patrimônio Final: <strong>${formatarMoeda(patrimonioFinalPeriodo)}</strong></p>
                <p>Variação no Período: <strong class="${variacaoTotal >= 0 ? 'positivo' : 'negativo'}">${formatarMoeda(variacaoTotal)}</strong></p>
                <p>Variação Percentual: <strong class="${variacaoTotal >= 0 ? 'positivo' : 'negativo'}">${isFinite(variacaoPercentual) ? variacaoPercentual.toFixed(2) + '%' : (variacaoTotal > 0 ? '∞%' : '-∞%')}</strong></p>
            `;
            resumoAgregadoContainerEl.appendChild(divResumo);
        }
        function calcularCrescimentoMensalPatrimonio(anoMesFiltro, spanId) { /* ... (implementation from previous response, scope querySelector to patrimonioView) ... */ 
            const spanElement = patrimonioView.querySelector(`#${spanId}`); 
            if (!spanElement) { return; }
            const entradasDoMesAtual = dadosPatrimonio.filter(item => item.data.startsWith(anoMesFiltro)).sort((a, b) => new Date(a.data + 'T00:00:00Z') - new Date(b.data + 'T00:00:00Z'));
            let crescimento = 0;
            if (entradasDoMesAtual.length > 0) {
                const ultimoPatrimonioDoMesAtual = entradasDoMesAtual[entradasDoMesAtual.length - 1].patrimonio;
                const [ano, mes] = anoMesFiltro.split('-').map(Number);
                let anoAnterior = ano; let mesAnteriorNum = mes - 1;
                if (mesAnteriorNum === 0) { mesAnteriorNum = 12; anoAnterior--; }
                const mesAnteriorFiltro = `${anoAnterior}-${String(mesAnteriorNum).padStart(2, '0')}`;
                const entradasDoMesAnterior = dadosPatrimonio.filter(item => item.data.startsWith(mesAnteriorFiltro)).sort((a, b) => new Date(a.data + 'T00:00:00Z') - new Date(b.data + 'T00:00:00Z'));
                const ultimoPatrimonioMesAnterior = entradasDoMesAnterior.length > 0 ? entradasDoMesAnterior[entradasDoMesAnterior.length - 1].patrimonio : 0;
                
                if (entradasDoMesAnterior.length === 0) { 
                    const todosDadosOrdenados = [...dadosPatrimonio].sort((a, b) => new Date(a.data + 'T00:00:00Z') - new Date(b.data + 'T00:00:00Z'));
                    const primeiroMesComDadosGeral = todosDadosOrdenados.length > 0 ? todosDadosOrdenados[0].data.substring(0,7) : null;
                    
                    if (anoMesFiltro === primeiroMesComDadosGeral || todosDadosOrdenados.filter(d => new Date(d.data + 'T00:00:00Z') < new Date(entradasDoMesAtual[0].data + 'T00:00:00Z')).length === 0) {
                        if(entradasDoMesAtual.length > 1) {
                            crescimento = ultimoPatrimonioDoMesAtual - entradasDoMesAtual[0].patrimonio;
                        } else if (entradasDoMesAtual.length === 1) {
                             crescimento = ultimoPatrimonioDoMesAtual - entradasDoMesAtual[0].patrimonio; 
                        }
                    } else {
                        crescimento = ultimoPatrimonioDoMesAtual - (entradasDoMesAtual[0]?.patrimonio || 0);
                    }
                } else {
                     crescimento = ultimoPatrimonioDoMesAtual - ultimoPatrimonioMesAnterior;
                }
            }
            spanElement.textContent = formatarMoeda(crescimento);
            spanElement.className = 'valor-card';
            if (crescimento > 0) spanElement.classList.add('positivo');
            else if (crescimento < 0) spanElement.classList.add('negativo');
        }
        function atualizarCardsResumoPatrimonio() { /* ... (implementation from previous response, scope querySelector to patrimonioView) ... */ 
            const sDV = patrimonioView.querySelector('#diaMaisForteValor');
            const sDD = patrimonioView.querySelector('#diaMaisForteData');
            if (dadosPatrimonio.length === 0) {
                if(sDV) sDV.textContent = formatarMoeda(0);
                if(sDD) sDD.textContent = "-";
            } else {
                const dOV = [...dadosPatrimonio].sort((a, b) => b.patrimonio - a.patrimonio || new Date(b.data + 'T00:00:00Z') - new Date(a.data + 'T00:00:00Z'));
                const mPI = dOV[0];
                if(sDV && mPI) sDV.textContent = formatarMoeda(mPI.patrimonio); else if(sDV) sDV.textContent = formatarMoeda(0);
                if(sDD && mPI) sDD.textContent = formatarDataCompletaParaExibicao(mPI.data); else if(sDD) sDD.textContent = "-";
            }
            calcularCrescimentoMensalPatrimonio("2025-03", "crescimentoMarco");
            calcularCrescimentoMensalPatrimonio("2025-04", "crescimentoAbril");
            atualizarDisplayMeta();
            calcularMaiorVariacaoDiariaPatrimonio();
        }
        function atualizarGraficoPatrimonio() { /* ... (implementation from previous response, scope querySelector to patrimonioView) ... */ 
             const dO = [...dadosPatrimonio].sort((a, b) => new Date(a.data + 'T00:00:00Z') - new Date(b.data + 'T00:00:00Z'));
            const chartDataPoints = dO.map(item => ({ x: formatarDataParaEixoX(item.data), y: item.patrimonio }));
            const cS = getComputedStyle(document.body); 
            const primaryChartColor = cS.getPropertyValue('--cosmos-cyan-accent').trim() || '#6AF2F0';
            const gridColor = cS.getPropertyValue('--cosmos-input-border').trim() || 'rgba(124, 58, 237, 0.2)';
            const textColor = cS.getPropertyValue('--cosmos-text-secondary').trim() || '#A0AEC0';
            const legendColor = cS.getPropertyValue('--cosmos-text-primary').trim() || '#E0E0E0';
            const warningColor = cS.getPropertyValue('--cosmos-warning').trim() || '#FBBF24';

            const datasets = [{
                label: 'Patrimônio (UM)', data: chartDataPoints, borderColor: primaryChartColor,
                backgroundColor: primaryChartColor + '26', tension: 0.3, fill: true,
                pointBackgroundColor: primaryChartColor, pointBorderColor: 'var(--cosmos-bg)',
                pointHoverBackgroundColor: 'var(--cosmos-bg)', pointHoverBorderColor: primaryChartColor,
                pointRadius: 4, pointHoverRadius: 7, order: 1,
                segment: { 
                    borderColor: ctx => {
                        if (!ctx.p0 || !ctx.p1) return primaryChartColor;
                        const prev = ctx.p0.parsed.y;
                        const curr = ctx.p1.parsed.y;
                        return curr < prev ? 'var(--cosmos-negative)' : primaryChartColor;
                    }
                }
            }];

            if (metaPatrimonio > 0) {
                datasets.push({
                    label: 'Meta Galáctica',
                    data: chartDataPoints.map(p => ({ x: p.x, y: metaPatrimonio })), 
                    borderColor: warningColor, borderWidth: 2, borderDash: [5, 5],
                    pointRadius: 0, fill: false, tension: 0, order: 0
                });
            }

            const opt = {
                responsive: true, maintainAspectRatio: false,
                scales: {
                    x: {
                        type: 'time',
                        adapters: { date: { locale: window.dateFns?.locale?.ptBR } },
                        time: { unit: 'month', tooltipFormat: 'dd/MM/yyyy', displayFormats: { month: 'MMM/yy', day: 'dd/MM' } },
                        ticks: { color: textColor, font: { family: 'var(--font-body)' }, source: 'auto', maxRotation: 45, minRotation: 30, autoSkip: true, autoSkipPadding: 20 },
                        grid: { color: gridColor, borderColor: gridColor }
                    },
                    y: {
                        beginAtZero: false,
                        ticks: { callback: function(v) { return formatarMoeda(v); }, color: textColor, font: { family: 'var(--font-body)' } },
                        grid: { color: gridColor, borderColor: gridColor }
                    }
                },
                plugins: {
                    legend: { display: true, position: 'top', labels: { color: legendColor, font: { family: 'var(--font-title)' } } },
                    tooltip: {
                        backgroundColor: 'rgba(13,17,23,0.9)', titleFont: { family: 'var(--font-title)'}, bodyFont: { family: 'var(--font-body)'},
                        titleColor: primaryChartColor, bodyColor: legendColor, borderColor: primaryChartColor, borderWidth:1,
                        callbacks: { 
                            title: function(tooltipItems) {
                                if (tooltipItems.length > 0 && tooltipItems[0].parsed) {
                                    const date = new Date(tooltipItems[0].parsed.x);
                                    return window.dateFns && window.dateFns.format ? window.dateFns.format(date, 'dd/MM/yyyy', { locale: window.dateFns.locale?.ptBR }) : date.toLocaleDateString('pt-BR', {timeZone: 'UTC'});
                                } return '';
                            },
                            label: function(ctx) { let l = ctx.dataset.label || ''; if (l) l += ': '; if (ctx.parsed?.y !== null && ctx.parsed?.y !== undefined) l += formatarMoeda(ctx.parsed.y); return l; } 
                        }
                    }
                },
                interaction: { mode: 'index', intersect: false },
            };

            if (patrimonioChartInstance) {
                patrimonioChartInstance.data.datasets = datasets;
                patrimonioChartInstance.options = opt;
                patrimonioChartInstance.update('none');
            } else {
                const ctx = patrimonioView.querySelector('#patrimonioChart')?.getContext('2d');
                if (!ctx) { console.error("Contexto do canvas #patrimonioChart não encontrado!"); return; }
                patrimonioChartInstance = new Chart(ctx, { type: 'line', data: { datasets: datasets }, options: opt });
            }
        }
        window.refreshPatrimonioPage = function() { // Called when page is shown again
            console.log("Refreshing Patrimônio Page Data");
            showGlobalLoading();
            carregarMetaDoFirebase().finally(() => {
                // Re-attach listener or re-fetch data to ensure UI is current
                onValue(patrimonioRef, (snapshot) => {
                    if (snapshot.exists()) {
                        const dadosDoFirebase = snapshot.val();
                        dadosPatrimonio = Object.keys(dadosDoFirebase).map(key => ({ firebaseId: key, ...dadosDoFirebase[key] }));
                        nextId = dadosPatrimonio.length > 0 ? (Math.max(0, ...dadosPatrimonio.map(d => d.id || 0)) + 1) : 1;
                    } else {
                        dadosPatrimonio = []; nextId = 1;
                    }
                    renderizarTabelaPatrimonio();
                    hideGlobalLoading();
                }, { onlyOnce: true }); // Fetch once to refresh, or maintain listener if preferred
            });
        };

        showGlobalLoading();
        carregarMetaDoFirebase(); 
        onValue(patrimonioRef, (snapshot) => {
            console.log("Dados de registros (Patrimônio) recebidos do Firebase em tempo real.");
            if (snapshot.exists()) {
                const dadosDoFirebase = snapshot.val();
                dadosPatrimonio = Object.keys(dadosDoFirebase).map(key => ({
                    firebaseId: key,
                    ...dadosDoFirebase[key]
                }));
                nextId = dadosPatrimonio.length > 0 ? (Math.max(0, ...dadosPatrimonio.map(d => d.id || 0)) + 1) : 1;
            } else {
                dadosPatrimonio = [];
                nextId = 1;
            }
            if (document.getElementById('page-patrimonio').classList.contains('hidden')) {
                 console.log("Patrimônio page is hidden, deferring render.");
                 hideGlobalLoading();
            } else {
                renderizarTabelaPatrimonio(); 
                hideGlobalLoading();
            }
        }, (error) => {
            console.error("Erro ao escutar dados de registros do Firebase (Patrimônio):", error);
            showGlobalNotification("Falha na conexão em tempo real com a base de registros estelar.", "error");
            hideGlobalLoading();
        });
      } 


      // --- Empréstimos Page Script ---
      function initEmprestimosPage() {
        const database = databaseEmprestimos; // USE EMPRÉSTIMOS' DB INSTANCE
        const { ref, get, set, update, push, remove, child, onValue } = window.firebaseDbFunctions; // Added onValue
        const emprestimosView = document.getElementById('page-emprestimos');
        const emprestimosRef = ref(database, 'emprestimos'); // Path in unified DB
        const tableBody = emprestimosView.querySelector('#clientTableBody');
        const valorCirculacaoPrincipalEl = emprestimosView.querySelector('#valorCirculacaoPrincipal');
        const totalGirandoEl = emprestimosView.querySelector('#totalGirando');
        const valorLucroReceberEl = emprestimosView.querySelector('#valorLucroReceber');
        const valorMediaPorcentagemEl = emprestimosView.querySelector('#valorMediaPorcentagem');
        const valorLucroRealizadoEl = emprestimosView.querySelector('#valorLucroRealizado');
        const addClientBtn = emprestimosView.querySelector('#addClientBtn');
        const confirmDeleteOverlay = emprestimosView.querySelector('#confirmDeleteOverlay');
        const confirmDeleteModal = emprestimosView.querySelector('#confirmDeleteModal');
        const confirmDeleteBtn = emprestimosView.querySelector('#confirmDeleteBtn');
        const cancelDeleteBtn = emprestimosView.querySelector('#cancelDeleteBtn');
        const modalMessage = confirmDeleteModal?.querySelector('.modal-message');
        const clientSummarySection = emprestimosView.querySelector('#clientSummarySection');
        const clientSummaryList = emprestimosView.querySelector('#clientSummaryList');
        const clientChartContainer = emprestimosView.querySelector('#clientChartContainer');
        const clientDebtChartCanvas = emprestimosView.querySelector('#clientDebtChart');
        const chartPlaceholder = emprestimosView.querySelector('#chartPlaceholder');
        const financialAnalysisSection = emprestimosView.querySelector('#financialAnalysisSection');
        const investmentLimitContainer = emprestimosView.querySelector('#investmentLimitContainer');
        const circulacaoValorEl = emprestimosView.querySelector('#circulacaoValor');
        const limiteValorEl = emprestimosView.querySelector('#limiteValor');
        const disponivelValorEl = emprestimosView.querySelector('#disponivelValor');
        const progressBarFillEl = emprestimosView.querySelector('#progressBarFill');
        const progressBarPercentageEl = emprestimosView.querySelector('#progressBarPercentage');
        const additionalChartsContainer = emprestimosView.querySelector('#additionalChartsContainer');
        const profitMarginChartCanvas = emprestimosView.querySelector('#profitMarginChart');
        const profitMarginPlaceholder = emprestimosView.querySelector('#profitMarginPlaceholder');
        const loanStatusChartCanvas = emprestimosView.querySelector('#loanStatusChart');
        const loanStatusPlaceholder = emprestimosView.querySelector('#loanStatusPlaceholder');
        const cashFlowSection = emprestimosView.querySelector('#cashFlowSection');
        const cashFlowChartCanvas = emprestimosView.querySelector('#cashFlowChart');
        const cashFlowPlaceholder = emprestimosView.querySelector('#cashFlowPlaceholder');
        let clientData = [];
        let loanIdToDelete = null;
        let summaryRendered = false; let financialAnalysisRendered = false; let cashFlowRendered = false;
        let clientChartInstance = null; let profitMarginChartInstance = null; let loanStatusChartInstance = null; let cashFlowChartInstance = null;
        const INITIAL_INVESTMENT_LIMIT = 3000;

        const formatCurrency = (value) => { try { return isNaN(value) ? 'R$ 0,00' : value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); } catch { return 'R$ 0,00'; }};
        const formatPercentage = (value) => { try { return (isNaN(value) || !isFinite(value)) ? '0.00%' : value.toFixed(2) + '%'; } catch { return '0.00%'; }};
        const calculatePercentageInterest = (valorEmprestimo, jurosDinheiro) => { const val = parseFloat(valorEmprestimo); const juros = parseFloat(jurosDinheiro); if (!val || val <= 0 || isNaN(val) || isNaN(juros)) return 0; return (juros / val) * 100; };
        const calculateTotalValue = (emprestimo) => { const valor = parseFloat(emprestimo?.valorEmprestimo) || 0; const juros = parseFloat(emprestimo?.jurosDinheiro) || 0; return valor + juros; };
        function addOneMonth(dateString) { if (!dateString || isNaN(new Date(dateString).getTime())) { return dateString || ''; } try { const date = new Date(dateString + 'T00:00:00'); date.setMonth(date.getMonth() + 1); const year = date.getFullYear(); const month = String(date.getMonth() + 1).padStart(2, '0'); const day = String(date.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`; } catch (error) { console.error("Erro addOneMonth (Empréstimos):", error); return dateString; } }
        function generateChartColors(count) { 
            const base = [ /* ... (same as before) ... */ 
                'rgba(167, 139, 250, 0.8)','rgba(96, 165, 250, 0.8)',
                'rgba(52, 211, 153, 0.8)', 'rgba(251, 191, 36, 0.8)',
                'rgba(248, 113, 113, 0.8)','rgba(236, 72, 153, 0.8)',
                'rgba(192, 132, 252, 0.75)','rgba(129, 140, 248, 0.75)'
            ];
            const c = []; for (let i = 0; i < count; i++) c.push(base[i % base.length]); return c;
        }
        function sortClientDataByDate() { clientData.sort((a, b) => { const dateA = a?.dataEmprestimo ? new Date(a.dataEmprestimo + 'T00:00:00') : null; const dateB = b?.dataEmprestimo ? new Date(b.dataEmprestimo + 'T00:00:00') : null; if (!dateA && !dateB) return 0; if (!dateA) return 1; if (!dateB) return -1; return dateA - dateB; }); }
        const calculateTotalGirando = () => clientData.filter(c => c && !c.pago).reduce((sum, c) => sum + calculateTotalValue(c), 0);
        const calculateEmCirculacao = () => clientData.filter(c => c && !c.pago).reduce((sum, c) => sum + (parseFloat(c.valorEmprestimo) || 0), 0);
        const calculateLucroAReceber = () => clientData.filter(c => c && !c.pago).reduce((sum, c) => sum + (parseFloat(c.jurosDinheiro) || 0), 0);
        const calculateMediaPorcentagem = () => { const v = clientData.filter(c => c && c.valorEmprestimo > 0 && !c.pago); if (v.length === 0) return 0; const p = v.map(c => calculatePercentageInterest(c.valorEmprestimo, c.jurosDinheiro)); const s = p.reduce((a, c) => a + c, 0); return s / v.length; };
        const calculateLucroRealizado = () => clientData.filter(c => c && c.pago).reduce((sum, c) => sum + (parseFloat(c.jurosDinheiro) || 0), 0);
        const calculateCurrentLimit = () => INITIAL_INVESTMENT_LIMIT + calculateLucroRealizado();
        function animateCounter(el, start, end, duration) { /* ... (same as before) ... */ let startT = null; function step(ts) { if (!startT) startT = ts; const p = Math.min((ts - startT) / duration, 1); const easedProgress = 1 - Math.pow(1 - p, 3); const current = start + (end - start) * easedProgress; if (el) el.textContent = formatCurrency(current); if (p < 1) requestAnimationFrame(step); else if (el) el.textContent = formatCurrency(end); } requestAnimationFrame(step); }
        const updateCounters = () => { /* ... (same as before) ... */ try{ const vC = calculateEmCirculacao(); const tG = calculateTotalGirando(); const currentVC = parseFloat(valorCirculacaoPrincipalEl?.textContent.replace(/[^0-9,-]/g, '').replace(',', '.')) || 0; const currentTG = parseFloat(totalGirandoEl?.textContent.replace(/[^0-9,-]/g, '').replace(',', '.')) || 0; const currentLR = parseFloat(valorLucroReceberEl?.textContent.replace(/[^0-9,-]/g, '').replace(',', '.')) || 0; const currentLReal = parseFloat(valorLucroRealizadoEl?.textContent.replace(/[^0-9,-]/g, '').replace(',', '.')) || 0; animateCounter(valorCirculacaoPrincipalEl, currentVC, vC, 800); animateCounter(totalGirandoEl, currentTG, tG, 800); animateCounter(valorLucroReceberEl, currentLR, calculateLucroAReceber(), 800); animateCounter(valorLucroRealizadoEl, currentLReal, calculateLucroRealizado(), 800); if(valorMediaPorcentagemEl) valorMediaPorcentagemEl.textContent = formatPercentage(calculateMediaPorcentagem()); } catch (e) { console.error("Erro em updateCounters (Empréstimos):", e);} };
        function calculateClientSummaries() { /* ... (same as before) ... */ const summary = {}; clientData.forEach((client) => { if (client && client.pago === false && client.nome && client.nome.trim() !== '') { const normalizedName = client.nome.trim().toLowerCase(); const originalName = client.nome.trim(); const totalValue = calculateTotalValue(client); if (summary[normalizedName]) { summary[normalizedName].totalDue += totalValue; } else { summary[normalizedName] = { name: originalName, totalDue: totalValue }; } } }); const summaryArray = Object.values(summary); summaryArray.sort((a, b) => b.totalDue - a.totalDue); return summaryArray; }
        function renderClientSummaries(summaries) { /* ... (same as before) ... */ if (!clientSummaryList) return; clientSummaryList.innerHTML = ''; if (summaries.length === 0) { clientSummaryList.innerHTML = '<p class="summary-placeholder">Nenhum valor pendente nesta galáxia.</p>'; return; } summaries.forEach(item => { const el = document.createElement('div'); el.classList.add('client-summary-item'); el.innerHTML = `<div class="client-name">${item.name}</div><div class="client-total-due">${formatCurrency(item.totalDue)}</div>`; clientSummaryList.appendChild(el); }); summaryRendered = true; }
        function renderOrUpdateClientChart(summaries) { /* ... (same as before) ... */ try { if (!clientDebtChartCanvas || !clientChartContainer) return; const ctx = clientDebtChartCanvas.getContext('2d'); const hasData = summaries && summaries.length > 0; chartPlaceholder.style.display = hasData ? 'none' : 'block'; clientDebtChartCanvas.style.display = hasData ? 'block' : 'none'; if (!hasData) { if (clientChartInstance) { clientChartInstance.destroy(); clientChartInstance = null; } chartPlaceholder.textContent = "Nenhum explorador com pendências."; return; } const labels = summaries.map(item => item.name); const dataValues = summaries.map(item => item.totalDue); const backgroundColors = generateChartColors(summaries.length); const config = { type: 'doughnut', data: { labels: labels, datasets: [{ label: 'Valor Devido', data: dataValues, backgroundColor: backgroundColors, borderColor: '#0D1117', borderWidth: 2, hoverOffset: 8, hoverBorderColor: '#fff', hoverBorderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '65%', plugins: { legend: { position: 'bottom', labels: { color: '#E0E0E0', padding: 15, boxWidth: 12, font: { size: 11 } } }, tooltip: { callbacks: { label: (ctx) => `${ctx.label || ''}: ${formatCurrency(ctx.parsed)}` }, backgroundColor: 'rgba(13, 17, 23, 0.95)', titleFont: { size: 13, weight: '500' }, bodyFont: { size: 12 }, padding: 10, cornerRadius: 6, displayColors: true, boxPadding: 4, titleMarginBottom: 6, bodySpacing: 3 } }, layout: { padding: { top: 10, bottom: 10 } }, animation: { animateScale: true, animateRotate: true, duration: 800, easing: 'easeOutCubic' } } }; if (clientChartInstance) { clientChartInstance.data.labels = labels; clientChartInstance.data.datasets[0].data = dataValues; clientChartInstance.data.datasets[0].backgroundColor = backgroundColors; clientChartInstance.update('none'); } else { clientChartInstance = new Chart(ctx, config); } } catch(e) { console.error("Erro Gráfico Cliente (Empréstimos):", e); if (chartPlaceholder) { chartPlaceholder.textContent = "Falha ao renderizar mapa estelar."; chartPlaceholder.style.display = 'block'; } if (clientDebtChartCanvas) clientDebtChartCanvas.style.display = 'none'; if (clientChartInstance) { clientChartInstance.destroy(); clientChartInstance = null; } } }
        function triggerClientSummaryRender() { /* ... (same as before) ... */ try { const s = calculateClientSummaries(); renderClientSummaries(s); renderOrUpdateClientChart(s); } catch (e) { console.error("Erro trigger Cliente (Empréstimos):", e); } }
        function updateInvestmentLimitBar() { /* ... (same as before) ... */ if (!progressBarFillEl || !circulacaoValorEl || !limiteValorEl || !disponivelValorEl || !progressBarPercentageEl) return; const emCirc = calculateEmCirculacao(); const limit = calculateCurrentLimit(); let effLimit = limit; if (emCirc > limit) effLimit = emCirc; const disp = effLimit - emCirc; let perc = 0; if (effLimit > 0) perc = Math.min(100, (emCirc / effLimit) * 100); else if (emCirc > 0) perc = 100; circulacaoValorEl.textContent = formatCurrency(emCirc); limiteValorEl.textContent = formatCurrency(effLimit); disponivelValorEl.textContent = formatCurrency(disp > 0 ? disp : 0); progressBarPercentageEl.textContent = `${perc.toFixed(1)}% Utilizado`; progressBarFillEl.style.width = `${perc}%`; disponivelValorEl.className = 'available'; if (disp <= 0) disponivelValorEl.classList.add('danger'); else if (perc > 85) disponivelValorEl.classList.add('warning'); }
        function renderOrUpdateAdditionalCharts() { /* ... (same as before) ... */ try { if (profitMarginChartCanvas && profitMarginPlaceholder) { const ctx = profitMarginChartCanvas.getContext('2d'); const p = clientData.reduce((s, c) => s + (parseFloat(c.valorEmprestimo) || 0), 0); const j = clientData.reduce((s, c) => s + (parseFloat(c.jurosDinheiro) || 0), 0); const has = p > 0 || j > 0; profitMarginPlaceholder.style.display = has ? 'none' : 'block'; profitMarginChartCanvas.style.display = has ? 'block' : 'none'; if (!has) { if (profitMarginChartInstance) { profitMarginChartInstance.destroy(); profitMarginChartInstance = null; } profitMarginPlaceholder.textContent = "Dados insuficientes para análise."; } else { const d = { labels: ['Capital Base Total', 'Rendimento Estelar Total'], datasets: [{ data: [p, j], backgroundColor: generateChartColors(2).slice(0,2), borderColor: '#0D1117', borderWidth: 2, hoverOffset: 5 }] }; const cfg = { type: 'pie', data: d, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#E0E0E0', padding: 12 } }, tooltip: { callbacks: { label: (c) => `${c.label||''}: ${formatCurrency(c.parsed)}` }, backgroundColor: 'rgba(13, 17, 23, 0.95)', cornerRadius: 6, padding: 10 } }, animation: { animateScale: true, duration: 700, easing: 'easeOutBack' } } }; if (profitMarginChartInstance) { profitMarginChartInstance.data = d; profitMarginChartInstance.update('none'); } else { profitMarginChartInstance = new Chart(ctx, cfg); }}} if (loanStatusChartCanvas && loanStatusPlaceholder) { const ctx = loanStatusChartCanvas.getContext('2d'); const pago = clientData.filter(c => c && c.pago).length; const naoPago = clientData.filter(c => c && !c.pago).length; const has = pago > 0 || naoPago > 0; loanStatusPlaceholder.style.display = has ? 'none' : 'block'; loanStatusChartCanvas.style.display = has ? 'block' : 'none'; if (!has) { if (loanStatusChartInstance) { loanStatusChartInstance.destroy(); loanStatusChartInstance = null; } loanStatusPlaceholder.textContent = "Nenhuma missão registrada."; } else { const d = { labels: ['Missões Concluídas', 'Missões em Andamento'], datasets: [{ data: [pago, naoPago], backgroundColor: generateChartColors(4).slice(2,4), borderColor: '#0D1117', borderWidth: 2, hoverOffset: 5 }] }; const cfg = { type: 'doughnut', data: d, options: { responsive: true, maintainAspectRatio: false, cutout: '60%', plugins: { legend: { position: 'bottom', labels: { color: '#E0E0E0', padding: 12 } }, tooltip: { callbacks: { label: (c) => `${c.label||''}: ${c.parsed}` }, backgroundColor: 'rgba(13, 17, 23, 0.95)', cornerRadius: 6, padding: 10 } }, animation: { animateScale: true, animateRotate: true, duration: 700, easing: 'easeOutCubic' } } }; if (loanStatusChartInstance) { loanStatusChartInstance.data = d; loanStatusChartInstance.update('none'); } else { loanStatusChartInstance = new Chart(ctx, cfg); }}} financialAnalysisRendered = true; } catch (e) { console.error("Erro Gráficos Adicionais (Empréstimos):", e); } }
        function triggerFinancialAnalysisRender() { /* ... (same as before) ... */ try { updateInvestmentLimitBar(); renderOrUpdateAdditionalCharts(); } catch(e) { console.error("Erro trigger Análise (Empréstimos):", e); } }
        function calculateCashFlowData() { /* ... (same as before) ... */ if (clientData.length === 0) return [{ x: new Date(), y: INITIAL_INVESTMENT_LIMIT }]; let transactions = []; let firstDate = null; clientData.forEach(loan => { if (loan.dataEmprestimo && (!firstDate || new Date(loan.dataEmprestimo) < firstDate)) firstDate = new Date(loan.dataEmprestimo + 'T00:00:00'); }); const startDate = firstDate || new Date(); const initialPointDate = new Date(startDate); initialPointDate.setDate(initialPointDate.getDate() - 1); transactions.push({ date: initialPointDate, value: INITIAL_INVESTMENT_LIMIT, type: 'initial' }); clientData.forEach(loan => { if (loan.dataEmprestimo && !isNaN(new Date(loan.dataEmprestimo).getTime())) { const amount = parseFloat(loan.valorEmprestimo) || 0; if (amount > 0) transactions.push({ date: new Date(loan.dataEmprestimo + 'T00:00:00'), value: -amount, type: 'loan_out' }); } if (loan.pago === true && loan.dataVencimento && !isNaN(new Date(loan.dataVencimento).getTime())) { const amount = calculateTotalValue(loan); if (amount > 0) transactions.push({ date: new Date(loan.dataVencimento + 'T00:00:00'), value: amount, type: 'payment_in' }); }}); transactions.sort((a, b) => a.date - b.date); let cashFlowPoints = []; let balance = 0; transactions.forEach((t, i) => { balance = (i === 0 && t.type === 'initial') ? t.value : balance + t.value; cashFlowPoints.push({ x: t.date.getTime(), y: balance }); }); return cashFlowPoints; }
        function renderOrUpdateCashFlowChart(cashFlowData) { /* ... (same as before) ... */ try { if (!cashFlowChartCanvas || !cashFlowPlaceholder) return; const ctx = cashFlowChartCanvas.getContext('2d'); if (!ctx) return; const hasData = cashFlowData && cashFlowData.length > 1; cashFlowPlaceholder.style.display = hasData ? 'none' : 'block'; cashFlowChartCanvas.style.display = hasData ? 'block' : 'none'; if (!hasData) { if (cashFlowChartInstance) { cashFlowChartInstance.destroy(); cashFlowChartInstance = null; } cashFlowPlaceholder.textContent = "Dados insuficientes para traçar rota."; return; } cashFlowData.sort((a, b) => a.x - b.x); const config = { type: 'line', data: { datasets: [{ label: 'Saldo Capital', data: cashFlowData, borderColor: generateChartColors(1)[2], backgroundColor: 'rgba(52, 211, 153, 0.1)', borderWidth: 2, pointBackgroundColor: generateChartColors(1)[2], pointBorderColor: '#fff', pointHoverBackgroundColor: '#fff', pointHoverBorderColor: generateChartColors(1)[2], tension: 0.2, fill: true, pointRadius: 3, pointHoverRadius: 6 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { type: 'time', adapter: { date: dateFns }, time: { unit: cashFlowData.length > 60 ? 'month' : 'day', tooltipFormat: 'dd/MM/yyyy', displayFormats: { month: 'MMM/yy', day: 'dd/MM' } }, ticks: { color: '#D1D5DB', maxRotation: 0, autoSkipPadding: 25 }, grid: { color: 'rgba(167, 139, 250, 0.08)' } }, y: { beginAtZero: false, ticks: { color: '#D1D5DB', callback: (v) => formatCurrency(v).replace('R$', '') }, grid: { color: 'rgba(167, 139, 250, 0.1)' } } }, plugins: { legend: { display: false }, tooltip: { callbacks: { title: (items) => items[0] ? dateFns.format(items[0].parsed.x, 'dd/MM/yyyy') : '', label: (ctx) => ` Saldo: ${formatCurrency(ctx.parsed.y)}` }, backgroundColor: 'rgba(13, 17, 23, 0.95)', titleFont: { size: 13 }, bodyFont: { size: 12 }, padding: 10, cornerRadius: 6, bodySpacing: 4 } }, interaction: { mode: 'index', intersect: false }, animation: { duration: 1000, easing: 'easeOutCubic' } } }; if (cashFlowChartInstance) { cashFlowChartInstance.data.datasets[0].data = cashFlowData; cashFlowChartInstance.options.scales.x.time.unit = cashFlowData.length > 60 ? 'month' : 'day'; cashFlowChartInstance.update('none'); } else { cashFlowChartInstance = new Chart(ctx, config); } cashFlowRendered = true; } catch (e) { console.error("Erro Gráfico Fluxo Caixa (Empréstimos):", e); if (cashFlowPlaceholder) { cashFlowPlaceholder.textContent = "Falha ao mapear fluxo temporal."; cashFlowPlaceholder.style.display = 'block'; } if (cashFlowChartCanvas) cashFlowChartCanvas.style.display = 'none'; if (cashFlowChartInstance) { cashFlowChartInstance.destroy(); cashFlowChartInstance = null; } } }
        function triggerCashFlowRender() { /* ... (same as before) ... */ try { const data = calculateCashFlowData(); renderOrUpdateCashFlowChart(data); } catch(e) { console.error("Erro trigger Fluxo (Empréstimos):", e); } }
        function updateAllDynamicSectionsEmprestimos() { /* ... (same as before) ... */ try { updateCounters(); } catch(e) { console.error("Erro updateCounters (Empréstimos):", e); } try { updateInvestmentLimitBar(); } catch(e) { console.error("Erro updateLimitBar (Empréstimos):", e); } const checkAndTrigger = (section, flagName, triggerFn) => { if (section?.classList.contains('visible') || !initializedPages[flagName]) { try { triggerFn(); } catch (e) { console.error(`Erro DENTRO trigger ${flagName} (Empréstimos):`, e); } } }; checkAndTrigger(clientSummarySection, 'summaryRenderedEmprestimos', triggerClientSummaryRender); checkAndTrigger(financialAnalysisSection, 'financialAnalysisRenderedEmprestimos', triggerFinancialAnalysisRender); checkAndTrigger(cashFlowSection, 'cashFlowRenderedEmprestimos', triggerCashFlowRender); }
        
        let summaryObserver, financialAnalysisObserver, cashFlowObserverEmprestimos;
        function setupIntersectionObserversEmprestimos() {
            if (summaryObserver) summaryObserver.disconnect();
            if (financialAnalysisObserver) financialAnalysisObserver.disconnect();
            if (cashFlowObserverEmprestimos) cashFlowObserverEmprestimos.disconnect();
            const createObserverCallback = (sectionElement, flagVarName, renderTriggerFn) => (entries, observer) => { entries.forEach(entry => { if (entry.isIntersecting) { if (sectionElement) sectionElement.classList.add('visible'); if (!initializedPages[flagVarName]) { initializedPages[flagVarName] = true; try { renderTriggerFn(); } catch(e) { console.error(`Erro trigger observer ${flagVarName} (Empréstimos):`, e); } } } }); };
            summaryObserver = new IntersectionObserver(createObserverCallback(clientSummarySection, 'summaryRenderedEmprestimos', triggerClientSummaryRender), { threshold: 0.05, rootMargin: "0px 0px -50px 0px" }); 
            if (clientSummarySection) summaryObserver.observe(clientSummarySection);
            financialAnalysisObserver = new IntersectionObserver(createObserverCallback(financialAnalysisSection, 'financialAnalysisRenderedEmprestimos', triggerFinancialAnalysisRender), { threshold: 0.05, rootMargin: "0px 0px -50px 0px" }); 
            if (financialAnalysisSection) financialAnalysisObserver.observe(financialAnalysisSection);
            cashFlowObserverEmprestimos = new IntersectionObserver(createObserverCallback(cashFlowSection, 'cashFlowRenderedEmprestimos', triggerCashFlowRender), { threshold: 0.05, rootMargin: "0px 0px -50px 0px" }); 
            if (cashFlowSection) cashFlowObserverEmprestimos.observe(cashFlowSection);
        }
        window.refreshEmprestimosPage = function() { 
            console.log("Refreshing Empréstimos Page Observers and Data");
            updateAllDynamicSectionsEmprestimos(); 
            setupIntersectionObserversEmprestimos();
        }
        const renderTableEmprestimos = () => { /* ... (implementation from previous response, check IDs and classes) ... */ 
            if (!tableBody) { return; }
            tableBody.innerHTML = '';
            if (!Array.isArray(clientData) || clientData.length === 0) {
               if(tableBody.innerHTML === '') {
                  tableBody.innerHTML = '<tr><td colspan="10" style="text-align:center; padding:30px; color:#A0AEC0;">Nenhuma missão de crédito detectada nos sensores.</td></tr>';
               }
               return;
            }
            clientData.forEach((client, index) => {
                try {
                   if (!client || typeof client.id === 'undefined') { console.warn(`[renderTableEmprestimos] Pulando item inválido no índice ${index}:`, client); return; }
                   const taxa = calculatePercentageInterest(client.valorEmprestimo, client.jurosDinheiro);
                   const total = calculateTotalValue(client);
                   const row = tableBody.insertRow();
                   row.setAttribute('data-id', client.id);
                   row.classList.add('row-entering');
                   const dataEmpFormatada = client.dataEmprestimo ? new Date(client.dataEmprestimo + 'T00:00:00').toLocaleDateString('pt-BR', { timeZone: 'UTC' }) : '';
                   const dataVencFormatada = client.dataVencimento ? new Date(client.dataVencimento + 'T00:00:00').toLocaleDateString('pt-BR', { timeZone: 'UTC' }) : '';

                   row.innerHTML = `
                       <td data-label="ID Sonda">${client.id.substring(0,8)}...</td>
                       <td data-label="Explorador" data-field="nome">${client.nome || 'S/N'}</td>
                       <td data-label="Valor Base" data-field="valorEmprestimo" data-type="number">${formatCurrency(client.valorEmprestimo)}</td>
                       <td data-label="Rendimento (R$)" data-field="jurosDinheiro" data-type="number">${formatCurrency(client.jurosDinheiro)}</td>
                       <td data-label="Taxa (%)" class="percentage-cell">${formatPercentage(taxa)}</td>
                       <td data-label="Data Lançamento" data-field="dataEmprestimo" data-type="date" data-value="${client.dataEmprestimo || ''}">${dataEmpFormatada}</td>
                       <td data-label="Data Retorno" data-field="dataVencimento" data-type="date" data-value="${client.dataVencimento || ''}">${dataVencFormatada}</td>
                       <td data-label="Valor Resgate">${formatCurrency(total)}</td>
                       <td data-label="Coletado?" data-field="pago" data-type="boolean"><input type="checkbox" ${client.pago ? 'checked' : ''} data-id="${client.id}"></td>
                       <td data-label="Comandos"><button class="delete-button" data-id="${client.id}">Ejetar</button></td>
                   `;
                   row.querySelectorAll('td[data-field]:not([data-field="pago"])').forEach(c => c.addEventListener('dblclick', (e) => makeCellEditableEmprestimos(e.currentTarget, client.id), { once: true }));
                   row.querySelector('input[type="checkbox"]')?.addEventListener('change', (e) => handleCheckboxChangeEmprestimos(e, client.id));
                   row.querySelector('.delete-button')?.addEventListener('click', () => showDeleteConfirmationEmprestimos(client.id));
                   requestAnimationFrame(() => { requestAnimationFrame(() => row.classList.add('visible')); });
                } catch (error) { console.error(`[renderTableEmprestimos] Erro renderizando linha ${index}, ID ${client?.id}:`, error); const errorRow = tableBody.insertRow(); errorRow.innerHTML = `<td colspan="10" style="color:orange; text-align:center;">Erro renderizando ID ${client?.id || '??'}</td>`; }
            });
        };
        const makeCellEditableEmprestimos = (cell, id) => { /* ... (implementation from previous response) ... */ 
            const client = clientData.find(cl => cl && cl.id === id);
            if (!client || cell.querySelector('input')) return;
            const field = cell.getAttribute('data-field');
            const type = cell.getAttribute('data-type');
            const originalValue = type === 'date' ? cell.getAttribute('data-value') : client[field];
            const originalHTML = cell.innerHTML;
            cell.classList.add('editing');
            cell.innerHTML = '';
            let inputElement;
            if (type === 'date') { inputElement = document.createElement('input'); inputElement.type = 'date'; inputElement.value = originalValue || ''; }
            else if (type === 'number') { inputElement = document.createElement('input'); inputElement.type = 'number'; inputElement.value = originalValue || 0; if (field === 'jurosDinheiro' || field === 'valorEmprestimo') inputElement.step = '0.01'; inputElement.min = '0'; }
            else { inputElement = document.createElement('input'); inputElement.type = 'text'; inputElement.value = originalValue || ''; }

            const save = () => {
                if (!cell.contains(inputElement)) return;
                cell.classList.remove('editing');
                saveEditEmprestimos(inputElement, cell, id, field, originalHTML);
            };
            const cancel = (event) => {
                event?.stopPropagation();
                if (!cell.contains(inputElement)) return;
                cell.classList.remove('editing');
                cell.innerHTML = originalHTML;
                setTimeout(() => {
                    if(document.body.contains(cell)) {
                       cell.addEventListener('dblclick', (e) => makeCellEditableEmprestimos(e.currentTarget, id), { once: true });
                    }
                }, 50);
            };

            inputElement.addEventListener('blur', save);
            inputElement.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); save(); } else if (e.key === 'Escape') { cancel(e); } });
            cell.appendChild(inputElement);
            inputElement.focus();
            inputElement.select();
        };
        async function saveEditEmprestimos(input, cell, id, field, originalHTML) { /* ... (implementation from previous response) ... */ 
           let newValue = input.value;
           const type = cell.getAttribute('data-type');
           let validationError = false;
           let valueToSave = newValue;

           if (type === 'number') { valueToSave = newValue.replace(',', '.'); valueToSave = parseFloat(valueToSave); if (isNaN(valueToSave) || valueToSave < 0) { alert('Valor numérico inválido.'); validationError = true; } }
           else if (type === 'date') { if (newValue && !/^\d{4}-\d{2}-\d{2}$/.test(newValue)) { alert('Formato de data inválido. Use AAAA-MM-DD.'); validationError = true; } else if (newValue && isNaN(new Date(newValue + 'T00:00:00').getTime())) { alert('Data inválida.'); validationError = true; } valueToSave = newValue; }
           else if (type === 'text') { valueToSave = newValue.trim(); }

           const clientIndex = clientData.findIndex(c => c && c.id === id);
           if (clientIndex === -1) { console.error(`Cliente com ID ${id} não encontrado localmente (Empréstimos).`); return; }

           const currentValue = clientData[clientIndex][field];
           let valueChanged = false;
           if (type === 'number') { valueChanged = parseFloat(currentValue) !== valueToSave; }
           else { valueChanged = currentValue != valueToSave; }

           if (validationError || !valueChanged) {
                cell.innerHTML = originalHTML;
                setTimeout(() => { if(document.body.contains(cell)) { cell.addEventListener('dblclick', (e) => makeCellEditableEmprestimos(e.currentTarget, id), { once: true }); } }, 50);
                return;
           }

           const updatePayload = { [field]: valueToSave };
           if (field === 'dataEmprestimo' && type === 'date' && !validationError) {
               updatePayload.dataVencimento = addOneMonth(valueToSave);
           }
           try {
               const recordRef = child(emprestimosRef, id);
               await update(recordRef, updatePayload);
               // onValue listener will handle UI update
           } catch (e) {
               console.error("[FRONTEND][saveEditEmprestimos] Erro no Firebase update:", e);
               alert(`Falha ao salvar no Firebase: ${e.message}`);
               cell.innerHTML = originalHTML;
                setTimeout(() => { if(document.body.contains(cell)) { cell.addEventListener('dblclick', (ev) => makeCellEditableEmprestimos(ev.currentTarget, id), { once: true }); } }, 50);
           }
        }
        async function handleCheckboxChangeEmprestimos(event, id) { /* ... (implementation from previous response) ... */ 
            const isChecked = event.target.checked;
            const idx = clientData.findIndex(c => c && c.id === id);
            if(idx === -1) return;
            const row = event.target.closest('tr');
            try {
                const recordRef = child(emprestimosRef, id);
                await update(recordRef, { pago: isChecked });
                // onValue listener will handle UI update
            } catch (e) {
                console.error("[FRONTEND] Erro handleCheckbox Firebase (Empréstimos):", e);
                alert(`Falha ao atualizar status no Firebase: ${e.message}`);
                event.target.checked = !isChecked; // Revert UI change on error
                if(row){ row.style.opacity = !isChecked ? 0.6 : 1; row.style.filter = !isChecked ? 'grayscale(60%)' : 'none';}
            }
        }
        async function addNewClientEmprestimos() { /* ... (implementation from previous response) ... */ 
            const date = new Date().toISOString().split('T')[0];
            const dueDate = addOneMonth(date);
            const newData = {
                nome: `Explorador #${Math.floor(Math.random()*1000)}`,
                valorEmprestimo: 0,
                jurosDinheiro: 0,
                dataEmprestimo: date,
                dataVencimento: dueDate,
                pago: false
            };
            try {
                const newRecordRef = await push(emprestimosRef, newData);
                // onValue listener will handle UI update
                // Focus logic might need adjustment if onValue re-renders immediately
                setTimeout(()=>{
                    const newId = newRecordRef.key;
                    const nR = tableBody.querySelector(`tr[data-id='${newId}']`);
                    if(nR){
                        nR.scrollIntoView({behavior:'smooth', block:'center'});
                        const cell = nR.querySelector('td[data-field="nome"]');
                        if(cell) setTimeout(() => makeCellEditableEmprestimos(cell, newId), 100);
                    }
                }, 300); // Delay to allow onValue to render first
            } catch (e) {
                console.error("[FRONTEND] Erro addNewClient Firebase (Empréstimos):", e);
                alert(`Falha ao adicionar no Firebase: ${e.message}`);
            }
        }
        function showDeleteConfirmationEmprestimos(id) { /* ... (implementation from previous response) ... */ const c=clientData.find(cl=>cl&&cl.id===id); if(!c) return; loanIdToDelete=id; if (modalMessage) modalMessage.innerHTML=`Ejetar missão de <strong>${c.nome||'S/N'}</strong> (ID Sonda: ${id.substring(0,8)}...)? <br><strong>Ação irreversível!</strong>`; if (confirmDeleteOverlay) confirmDeleteOverlay.classList.add('active'); }
        function hideConfirmationModalEmprestimos() { /* ... (implementation from previous response) ... */ if (confirmDeleteOverlay) confirmDeleteOverlay.classList.remove('active'); loanIdToDelete=null; }
        async function executeDeleteEmprestimos() { /* ... (implementation from previous response) ... */ 
            if(!loanIdToDelete) return;
            const id = loanIdToDelete;
            const row = tableBody.querySelector(`tr[data-id='${id}']`); // Keep for optimistic UI update
            if(confirmDeleteBtn) { confirmDeleteBtn.textContent='Ejetando...'; confirmDeleteBtn.disabled=true; }
            if(cancelDeleteBtn) cancelDeleteBtn.disabled=true;
            try {
                const recordRef = child(emprestimosRef, id);
                await remove(recordRef);
                // onValue listener will handle UI update. Optimistic removal for smoother UX:
                if(row){
                    row.classList.remove('visible');
                    row.classList.add('row-exiting','hidden');
                    setTimeout(() => { if(row.parentNode) row.remove() }, 400);
                }
                hideConfirmationModalEmprestimos();
            } catch(e) {
                console.error("[FRONTEND] Erro executeDelete Firebase (Empréstimos):", e);
                alert(`Falha ao ejetar no Firebase: ${e.message}`);
                if(row) row.classList.remove('row-exiting','hidden'); // Revert optimistic UI
            } finally {
                if(confirmDeleteBtn) { confirmDeleteBtn.textContent='Sim, Ejetar!'; confirmDeleteBtn.disabled=false; }
                if(cancelDeleteBtn) cancelDeleteBtn.disabled=false;
            }
        }
       
        if (addClientBtn) addClientBtn.addEventListener('click', addNewClientEmprestimos);
        if (confirmDeleteBtn) confirmDeleteBtn.addEventListener('click', executeDeleteEmprestimos);
        if (cancelDeleteBtn) cancelDeleteBtn.addEventListener('click', hideConfirmationModalEmprestimos);
        if (confirmDeleteOverlay) confirmDeleteOverlay.addEventListener('click', (e)=>{ if(e.target===confirmDeleteOverlay) { hideConfirmationModalEmprestimos();} });

        onValue(emprestimosRef, (snapshot) => {
            showGlobalLoading();
            console.log("Dados de Empréstimos recebidos/atualizados do Firebase.");
            if (snapshot.exists()) {
                const dataFromFirebase = snapshot.val();
                clientData = Object.entries(dataFromFirebase).map(([key, value]) => {
                    if (!value || typeof value !== 'object') { return null; }
                    return {
                        id: key, nome: String(value.nome || 'S/N'),
                        valorEmprestimo: parseFloat(value.valorEmprestimo) || 0,
                        jurosDinheiro: parseFloat(value.jurosDinheiro) || 0,
                        dataEmprestimo: value.dataEmprestimo || '',
                        dataVencimento: value.dataVencimento || '',
                        pago: value.pago === true || String(value.pago).toLowerCase() === 'true' || value.pago === 1
                    };
                }).filter(item => item !== null);
                sortClientDataByDate();
            } else { 
                clientData = []; 
                console.log("Nenhum dado de empréstimo encontrado no Firebase.");
            }
            
            if (document.getElementById('page-emprestimos').classList.contains('hidden')) {
                console.log("Empréstimos page is hidden, deferring full render/update.");
                 hideGlobalLoading();
            } else {
                renderTableEmprestimos();
                updateAllDynamicSectionsEmprestimos();
                setupIntersectionObserversEmprestimos();
                hideGlobalLoading();
            }
        }, (error) => {
            console.error("Erro ao escutar dados de Empréstimos do Firebase:", error);
            showGlobalNotification("Falha na conexão em tempo real com a base de empréstimos.", "error");
            clientData = [];
            if (!document.getElementById('page-emprestimos').classList.contains('hidden')) {
                renderTableEmprestimos(); // Render empty table
                updateAllDynamicSectionsEmprestimos(); // Update summaries
            }
            hideGlobalLoading();
        });
      } 


      // --- Gastos Page Script ---
      function initGastosPage() {
        const database = databaseGastos; // USE GASTOS' DB INSTANCE
        const { ref, get, set, update, push, remove, child, onValue } = window.firebaseDbFunctions;
        const gastosView = document.getElementById('page-gastos');
        const DB_PATH_ROOT_GASTOS = 'gastosGlobais'; // Path in unified DB
        let todosOsGastosCache = {}; // This will be populated by onValue
        let editandoTransacaoIdGastos = null;
        let currentEditingRowGastos = null;
        let dataSelecionadaAtualGastos = { ano: null, mes: null };
        let graficoGastosPorMotivoInstanceGastos = null; // Renamed
        let graficoEntradaSaidaInstanceGastos = null; // Renamed
        const datePickerMesAnoEl = gastosView.querySelector('#gastosDatePickerMesAno');
        const mesDetalhesContainerEl = gastosView.querySelector('#gastosMesDetalhesContainer');
        const formTransacaoTemplate = gastosView.querySelector('#gastosFormTransacaoTemplate');
        const confirmationModalOverlayEl = gastosView.querySelector('#gastosConfirmationModalOverlay');
        const confirmationModalTitleEl = gastosView.querySelector('#gastosConfirmationModalTitle');
        const confirmationModalMessageEl = gastosView.querySelector('#gastosConfirmationModalMessage');
        let confirmModalButtonEl = gastosView.querySelector('#gastosConfirmModalButton');
        let cancelModalButtonEl = gastosView.querySelector('#gastosCancelModalButton');
        const mesesNomes = { "01": "Janeiro", /* ... */ "12": "Dezembro" }; // Same as before
        const COSMIC_COLORS = [ /* ... */ ]; // Same as before
        let currentEscListenerGastos = null;

        function showConfirmationModalGastos(title, message, onConfirmCallback, onCancelCallback = null) { /* ... (implementation from previous response, ensure querySelectors are scoped to gastosView if needed) ... */ 
             confirmationModalTitleEl.textContent = title;
            confirmationModalMessageEl.textContent = message;
            confirmationModalOverlayEl.classList.add('visible');

            const newConfirmBtn = confirmModalButtonEl.cloneNode(true);
            confirmModalButtonEl.parentNode.replaceChild(newConfirmBtn, confirmModalButtonEl);
            confirmModalButtonEl = newConfirmBtn;

            const newCancelBtn = cancelModalButtonEl.cloneNode(true);
            cancelModalButtonEl.parentNode.replaceChild(newCancelBtn, cancelModalButtonEl);
            cancelModalButtonEl = newCancelBtn;

            confirmModalButtonEl.onclick = () => {
                hideConfirmationModalGastos();
                if (onConfirmCallback) onConfirmCallback();
            };

            cancelModalButtonEl.onclick = () => {
                hideConfirmationModalGastos();
                if (onCancelCallback) onCancelCallback();
            };
            
            const overlayClickListener = (event) => {
                if (event.target === confirmationModalOverlayEl) {
                    hideConfirmationModalGastos();
                    if (onCancelCallback) onCancelCallback();
                }
            };
            confirmationModalOverlayEl.addEventListener('click', overlayClickListener);

            if (currentEscListenerGastos) document.removeEventListener('keydown', currentEscListenerGastos);
            currentEscListenerGastos = (event) => {
                if (event.key === "Escape") {
                    hideConfirmationModalGastos();
                    if (onCancelCallback) onCancelCallback();
                }
            };
            document.addEventListener('keydown', currentEscListenerGastos);
            
            const originalHide = hideConfirmationModalGastos;
            hideConfirmationModalGastos = () => {
                originalHide(); // Calls the original function that removes the class
                confirmationModalOverlayEl.removeEventListener('click', overlayClickListener);
                if (currentEscListenerGastos) {
                    document.removeEventListener('keydown', currentEscListenerGastos);
                    currentEscListenerGastos = null;
                }
                hideConfirmationModalGastos = originalHide; 
            };
        }
        function hideConfirmationModalGastos() { confirmationModalOverlayEl.classList.remove('visible'); }
        function formatCurrencyGastos(value) { /* ... (same as before) ... */ 
             if (typeof value !== 'number') value = parseFloat(value) || 0;
            return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }
        function formatDateForInputGastos(dateObj) { /* ... (same as before) ... */ 
            if (!dateObj || !dateObj.year || !dateObj.month || !dateObj.day) return '';
            return `${dateObj.year}-${String(dateObj.month).padStart(2, '0')}-${String(dateObj.day).padStart(2, '0')}`;
        }
        function setDefaultMonthPickerGastos() { /* ... (same as before, uses todosOsGastosCache) ... */ 
            const anos = Object.keys(todosOsGastosCache).sort((a, b) => b - a);
            if (anos.length > 0) {
                const anoMaisRecente = anos[0];
                const mesesDoAno = Object.keys(todosOsGastosCache[anoMaisRecente]).sort((a,b) => b.localeCompare(a, undefined, {numeric: true}));
                if (mesesDoAno.length > 0) {
                    const mesMaisRecente = mesesDoAno[0];
                    datePickerMesAnoEl.value = `${anoMaisRecente}-${mesMaisRecente}`;
                    handleDateSelectionGastos(); // This will call renderizarDetalhesDoMesGastos
                } else {
                     setPickerToCurrentMonthEmptyGastos();
                }
            } else {
                setPickerToCurrentMonthEmptyGastos();
            }
        }
        function setPickerToCurrentMonthEmptyGastos() { /* ... (same as before) ... */ 
            const hoje = new Date();
            const anoAtual = hoje.getFullYear();
            const mesAtual = String(hoje.getMonth() + 1).padStart(2, '0');
            datePickerMesAnoEl.value = `${anoAtual}-${mesAtual}`;
            mesDetalhesContainerEl.innerHTML = `<div class="placeholder-mes"><span>🌠</span>Selecione um mês/ano para visualizar ou registrar seus gastos.</div>`;
            dataSelecionadaAtualGastos = { ano: anoAtual, mes: mesAtual }; // Update current selection
        }
        function calcularTotaisMesGastos(transacoesArray = []) { /* ... (same as before) ... */ 
            let totalEntradas = 0; let totalSaidas = 0; let saldoAcumulado = 0;
            const transacoesOrdenadas = [...transacoesArray].sort((a, b) => new Date(a.data + 'T00:00:00Z') - new Date(b.data + 'T00:00:00Z') || (a.id && b.id ? a.id.localeCompare(b.id) : 0) );
            const transacoesComSaldo = transacoesOrdenadas.map(tr => {
                const valor = parseFloat(tr.valor) || 0;
                if (tr.tipo === 'entrada') { totalEntradas += valor; saldoAcumulado += valor; }
                else { totalSaidas += valor; saldoAcumulado -= valor; }
                return { ...tr, valor, saldoApos: saldoAcumulado };
            });
            return { totalEntradas, totalSaidas, saldoMes: saldoAcumulado, transacoesComSaldo };
        }
        async function renderizarDetalhesDoMesGastos(ano, mes) { /* ... (implementation from previous response, uses todosOsGastosCache and scoped selectors) ... */ 
            showGlobalLoading();
            mesDetalhesContainerEl.innerHTML = ''; // Clear previous month's details
            dataSelecionadaAtualGastos = { ano, mes };

            const dadosDoMes = todosOsGastosCache[ano]?.[mes];
            let isMesNovo = !dadosDoMes;
            let transacoesDoMesArray = [];

            if (dadosDoMes && dadosDoMes.transacoes) {
                transacoesDoMesArray = (typeof dadosDoMes.transacoes === 'object' && !Array.isArray(dadosDoMes.transacoes))
                    ? Object.entries(dadosDoMes.transacoes).map(([id, trans]) => ({ id, ...trans }))
                    : Array.isArray(dadosDoMes.transacoes) ? dadosDoMes.transacoes : [];
            } else if (!dadosDoMes) {
                // This case is for a completely new month not in cache yet (should be rare if onValue works)
                isMesNovo = true;
            }
            
            const nomeDoMesDisplay = dadosDoMes?.nome || mesesNomes[mes] || `Mês ${mes}`;
            const anoDisplay = dadosDoMes?.ano || ano;

            if (isMesNovo) {
                showGlobalNotification(`Iniciando registros para ${nomeDoMesDisplay} de ${anoDisplay}. Adicione sua primeira transação de gastos.`, "info");
            }

            const { totalEntradas, totalSaidas, saldoMes, transacoesComSaldo } = calcularTotaisMesGastos(transacoesDoMesArray);

            const secaoHTML = `
            <section class="secao" data-ano="${ano}" data-mes="${mes}">
                <h2>${nomeDoMesDisplay} <span style="color: var(--cosmos-purple-secondary); font-size: 0.8em;">${anoDisplay}</span></h2>
                <div class="cards-container">
                    <div class="card"><h3>Entradas Celestiais</h3><p class="positivo">${formatCurrencyGastos(totalEntradas)}</p></div>
                    <div class="card"><h3>Drenos de Energia</h3><p class="negativo">${formatCurrencyGastos(totalSaidas)}</p></div>
                    <div class="card"><h3>Balanço Orbital</h3><p class="${saldoMes < 0 ? 'negativo' : 'positivo'}">${formatCurrencyGastos(saldoMes)}</p></div>
                </div>
                <h2 class="sub-titulo-graficos">Análise Visual dos Drenos</h2>
                <div class="graficos-container">
                    <div class="grafico-card"><h4 >Gastos por Motivo Galáctico</h4><canvas id="gastosGraficoGastosMotivo"></canvas><div id="gastosGraficoGastosMotivoPlaceholder" class="grafico-placeholder hidden">Sem dados de gastos.</div></div>
                    <div class="grafico-card"><h4>Entradas vs Saídas Cósmicas</h4><canvas id="gastosGraficoEntradaSaida"></canvas><div id="gastosGraficoEntradaSaidaPlaceholder" class="grafico-placeholder hidden">Sem dados suficientes.</div></div>
                </div>
                <button class="btn-adicionar-transacao-gastos" style="
                    border: none; padding: 0.7rem 1.5rem; border-radius: 0.375rem; cursor: pointer;
                    font-weight: 600; font-size: 1em; font-family: var(--font-title);
                    transition: all 0.25s ease-out; color: #fff;
                    background-image: linear-gradient(135deg, var(--cosmos-button-primary-bg-start) 0%, var(--cosmos-button-primary-bg-end) 100%);
                    text-shadow: 0 1px 2px rgba(0,0,0,0.25); margin-top: 2rem; margin-bottom: 1rem;
                    box-shadow: 0 2px 5px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.05);">
                    Nova Transação de Gastos 🌠
                </button>
                <div id="gastosFormContainer-${ano}-${mes}"></div>
                ${transacoesComSaldo.length === 0 ?
                    `<div class="placeholder-mes" style="margin-top:1rem; padding: 2rem;"><span>🚀</span>Nenhum registro para ${nomeDoMesDisplay} de ${anoDisplay}.<br>Adicione sua primeira transação!</div>`
                    :
                    `<div class="table-wrapper">
                        <table>
                            <thead><tr><th>DATA</th><th>MOTIVO</th><th>QUEM</th><th>VALOR</th><th>TIPO</th><th>SALDO APÓS</th><th>AÇÕES</th></tr></thead>
                            <tbody id="gastosTabelaCorpo">
                                ${transacoesComSaldo.map(tr => `
                                    <tr data-id="${tr.id}">
                                        <td>${new Date(tr.data + 'T00:00:00Z').toLocaleDateString('pt-BR', {timeZone: 'UTC'})}</td>
                                        <td>${tr.motivo || '-'}</td><td>${tr.quem || '-'}</td>
                                        <td class="currency ${tr.tipo === 'entrada' ? 'positivo' : 'negativo'}">${formatCurrencyGastos(tr.valor)}</td>
                                        <td class="center-text ${tr.tipo === 'entrada' ? 'positivo' : 'negativo'}">${tr.tipo === 'entrada' ? 'Entrada' : 'Saída'}</td>
                                        <td class="currency ${tr.saldoApos < 0 ? 'negativo' : 'positivo'}">${formatCurrencyGastos(tr.saldoApos)}</td>
                                        <td class="acoes-tabela">
                                            <button class="btn-editar-gasto" title="Editar">✏️</button>
                                            <button class="btn-excluir-gasto" title="Excluir">🗑️</button>
                                        </td></tr>`).join('')}
                            </tbody>
                            <tfoot><tr><td colspan="5">TOTAIS DA MISSÃO (${nomeDoMesDisplay.toUpperCase().substring(0,3)}/${String(anoDisplay).substring(2)}):</td><td class="currency ${saldoMes < 0 ? 'negativo' : 'positivo'}">${formatCurrencyGastos(saldoMes)}</td><td></td></tr></tfoot>
                        </table></div>`
                }
            </section>`;
            
            // Delay to allow HTML to be injected before attaching listeners and rendering charts
            setTimeout(() => {
                mesDetalhesContainerEl.innerHTML = secaoHTML;
                const secaoCarregada = mesDetalhesContainerEl.querySelector('.secao');
                if (secaoCarregada) {
                    setTimeout(() => secaoCarregada.classList.add('visible'), 50); // For animation
                    const btnAdicionar = secaoCarregada.querySelector('.btn-adicionar-transacao-gastos');
                    if (btnAdicionar) btnAdicionar.onclick = () => mostrarFormularioAdicaoGastos(ano, mes);
                    
                    secaoCarregada.querySelectorAll('.btn-editar-gasto').forEach(btn => {
                        const tr = btn.closest('tr');
                        const idTransacao = tr.dataset.id;
                        btn.onclick = () => iniciarEdicaoTransacaoGastos(ano, mes, idTransacao, tr);
                    });
                    secaoCarregada.querySelectorAll('.btn-excluir-gasto').forEach(btn => {
                        const tr = btn.closest('tr');
                        const idTransacao = tr.dataset.id;
                        btn.onclick = () => excluirTransacaoGastos(ano, mes, idTransacao);
                    });
                }
                renderizarGraficoGastosPorMotivoGastos(ano, mes);
                renderizarGraficoEntradaSaidaGastos(totalEntradas, totalSaidas);
                hideGlobalLoading();
                if (!isMesNovo && (dadosDoMes && dadosDoMes.transacoes && dadosDoMes.transacoes.length > 0) ) { // Only show if not a new month and has data
                   showGlobalNotification(`Dados de gastos de ${nomeDoMesDisplay} de ${anoDisplay} carregados!`, 'success', 2000);
                }
            }, 100); // Small delay for DOM update
        }
        function prepararDadosGraficoGastosGastos(ano, mes) { /* ... (same as before, uses todosOsGastosCache) ... */ 
            const dadosMes = todosOsGastosCache[ano]?.[mes];
            if (!dadosMes || !dadosMes.transacoes || dadosMes.transacoes.length === 0) {
                return { labels: [], data: [], colors: [] };
            }
            const gastos = dadosMes.transacoes.filter(t => t.tipo === 'saida');
            const gastosPorMotivo = {};
            gastos.forEach(gasto => {
                const motivo = (gasto.motivo || 'NÃO ESPECIFICADO').trim().toUpperCase();
                gastosPorMotivo[motivo] = (gastosPorMotivo[motivo] || 0) + parseFloat(gasto.valor);
            });
            const labels = Object.keys(gastosPorMotivo);
            const data = Object.values(gastosPorMotivo);
            let sortedGastos = [];
            for (let i=0; i < labels.length; i++) sortedGastos.push({label: labels[i], value: data[i]});
            sortedGastos.sort((a,b) => b.value - a.value);
            const topLabels = []; const topData = []; let outrosValor = 0; const maxCategorias = 8;
            if (sortedGastos.length > maxCategorias) {
                for (let i = 0; i < maxCategorias -1; i++) { topLabels.push(sortedGastos[i].label); topData.push(sortedGastos[i].value); }
                for (let i = maxCategorias -1; i < sortedGastos.length; i++) outrosValor += sortedGastos[i].value;
                if (outrosValor > 0) { topLabels.push("OUTROS GASTOS"); topData.push(outrosValor); }
            } else { sortedGastos.forEach(item => { topLabels.push(item.label); topData.push(item.value); }); }
            const colors = topLabels.map((_, index) => COSMIC_COLORS[index % COSMIC_COLORS.length]);
            return { labels: topLabels, data: topData, colors };
        }
        function renderizarGraficoGastosPorMotivoGastos(ano, mes) { /* ... (same as before, ensure scoped selectors) ... */ 
             const canvasEl = gastosView.querySelector('#gastosGraficoGastosMotivo'); 
            const placeholderEl = gastosView.querySelector('#gastosGraficoGastosMotivoPlaceholder');
            if (!canvasEl || !placeholderEl) return;

            const { labels, data, colors } = prepararDadosGraficoGastosGastos(ano, mes);

            if (graficoGastosPorMotivoInstanceGastos) graficoGastosPorMotivoInstanceGastos.destroy();

            if (labels.length === 0) {
                canvasEl.classList.add('hidden'); placeholderEl.classList.remove('hidden'); return;
            }
            canvasEl.classList.remove('hidden'); placeholderEl.classList.add('hidden');

            const ctx = canvasEl.getContext('2d');
            graficoGastosPorMotivoInstanceGastos = new Chart(ctx, {
                type: 'doughnut', data: { labels: labels, datasets: [{ label: 'Gastos por Motivo', data: data, backgroundColor: colors, borderColor: '#0D1117', borderWidth: 2, hoverOffset: 8 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: 'var(--cosmos-text-secondary)', font: { family: 'var(--font-body)', size: 10 }, boxWidth: 15, padding: 15 } }, tooltip: { backgroundColor: 'rgba(13,17,23,0.9)', titleFont: { family: 'var(--font-title)'}, bodyFont: { family: 'var(--font-body)'}, titleColor: 'var(--cosmos-cyan-accent)', bodyColor: 'var(--cosmos-text-primary)', borderColor: 'var(--cosmos-cyan-accent)', borderWidth: 1, callbacks: { label: function(context) { let label = context.label || ''; if (label) label += ': '; if (context.parsed !== null) { label += formatCurrencyGastos(context.parsed); const total = context.dataset.data.reduce((sum, val) => sum + val, 0); const percentage = total > 0 ? (context.parsed / total * 100).toFixed(1) : 0; label += ` (${percentage}%)`; } return label; } } } }, animation: { animateRotate: true, animateScale: true }, layout: { padding: 5 } }
            });
        }
        function renderizarGraficoEntradaSaidaGastos(totalEntradas, totalSaidas) { /* ... (same as before, ensure scoped selectors) ... */ 
            const canvasEl = gastosView.querySelector('#gastosGraficoEntradaSaida'); 
            const placeholderEl = gastosView.querySelector('#gastosGraficoEntradaSaidaPlaceholder');
            if (!canvasEl || !placeholderEl) return;

            if(graficoEntradaSaidaInstanceGastos) graficoEntradaSaidaInstanceGastos.destroy();

            if (totalEntradas === 0 && totalSaidas === 0) {
                 canvasEl.classList.add('hidden'); placeholderEl.classList.remove('hidden'); return;
            }
            canvasEl.classList.remove('hidden'); placeholderEl.classList.add('hidden');

            const ctx = canvasEl.getContext('2d');
            graficoEntradaSaidaInstanceGastos = new Chart(ctx, {
                type: 'pie', data: { labels: ['Entradas Celestiais', 'Drenos de Energia'], datasets: [{ data: [totalEntradas, totalSaidas], backgroundColor: ['rgba(52, 211, 153, 0.7)', 'rgba(248, 113, 113, 0.7)'], borderColor: ['var(--cosmos-positive)','var(--cosmos-negative)'], borderWidth: 2, hoverOffset: 8, hoverBorderColor: 'var(--cosmos-text-primary)'}] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: 'var(--cosmos-text-secondary)', font: { family: 'var(--font-body)', size: 11 }, boxWidth: 18, padding: 15 } }, tooltip: { backgroundColor: 'rgba(13,17,23,0.9)', titleFont: { family: 'var(--font-title)'}, bodyFont: { family: 'var(--font-body)'}, titleColor: 'var(--cosmos-cyan-accent)', bodyColor: 'var(--cosmos-text-primary)', borderColor: 'var(--cosmos-cyan-accent)', borderWidth: 1, callbacks: { label: function(context) { return `${context.label}: ${formatCurrencyGastos(context.raw)}`; } } } }, animation: { animateRotate: true, animateScale: false } }
            });
        }
        function mostrarFormularioAdicaoGastos(ano, mes) { /* ... (implementation from previous response, use scoped template and selectors) ... */ 
            cancelarAdicaoEdicaoTransacaoGastos(); 
            const formContainerId = `gastosFormContainer-${ano}-${mes}`;
            const formContainer = gastosView.querySelector(`#${formContainerId}`);

            if (!formContainer) {
                console.error(`ERRO: Container do formulário Gastos #${formContainerId} não encontrado!`);
                showGlobalNotification(`Erro interno: Não foi possível encontrar o local para exibir o formulário de gastos. (ID: ${formContainerId})`, "error");
                return;
            }

            const formClone = formTransacaoTemplate.content.cloneNode(true); 
            const formElement = formClone.querySelector('form');
            formContainer.appendChild(formClone);

            const h3 = formElement.querySelector('#gastosFormTransacaoTitulo');
            const dataInput = formElement.querySelector('#gastosTransData');
            const motivoInput = formElement.querySelector('#gastosTransMotivo');
            const quemInput = formElement.querySelector('#gastosTransQuem');
            const valorInput = formElement.querySelector('#gastosTransValor');
            const btnRegistrarRecebido = formElement.querySelector('.btn-registrar-recebido');
            const btnRegistrarEnvio = formElement.querySelector('.btn-registrar-envio');
            
            editandoTransacaoIdGastos = null; 
            h3.textContent = 'Adicionar Nova Transação de Gastos';

            const dataSelecionadaNoPicker = { year: parseInt(dataSelecionadaAtualGastos.ano), month: parseInt(dataSelecionadaAtualGastos.mes) };
            const hoje = new Date(); let diaSugerido = hoje.getDate();
            if (!(dataSelecionadaNoPicker.year === hoje.getFullYear() && dataSelecionadaNoPicker.month === (hoje.getMonth() + 1))) diaSugerido = 1;
            if (dataSelecionadaNoPicker.year && dataSelecionadaNoPicker.month) {
                dataInput.value = formatDateForInputGastos({ year: dataSelecionadaNoPicker.year, month: dataSelecionadaNoPicker.month, day: diaSugerido});
                dataInput.min = `${dataSelecionadaNoPicker.year}-${String(dataSelecionadaNoPicker.month).padStart(2, '0')}-01`;
                const ultimoDiaDoMes = new Date(dataSelecionadaNoPicker.year, dataSelecionadaNoPicker.month, 0).getDate();
                dataInput.max = `${dataSelecionadaNoPicker.year}-${String(dataSelecionadaNoPicker.month).padStart(2, '0')}-${String(ultimoDiaDoMes).padStart(2, '0')}`;
            } else {
                dataInput.valueAsDate = new Date();
            }
            
            btnRegistrarRecebido.onclick = () => {
                salvarTransacaoFirebaseGastos(ano, mes, formElement, 'entrada');
            };
            btnRegistrarEnvio.onclick = () => {
                salvarTransacaoFirebaseGastos(ano, mes, formElement, 'saida');
            };
        }
        async function salvarTransacaoFirebaseGastos(ano, mes, formElement, tipoTransacao) { /* ... (implementation from previous response, use DB_PATH_ROOT_GASTOS) ... */ 
            showGlobalLoading();
            const data = formElement.querySelector('#gastosTransData').value;
            const motivo = formElement.querySelector('#gastosTransMotivo').value.trim();
            const quem = formElement.querySelector('#gastosTransQuem').value.trim();
            const valor = parseFloat(formElement.querySelector('#gastosTransValor').value);

            if (!data || !motivo || !quem || isNaN(valor) || valor <= 0) {
                showGlobalNotification("Todos os campos de gastos são obrigatórios e o valor deve ser positivo.", "warning");
                hideGlobalLoading();
                return;
            }
            const transacaoData = { data, motivo, quem, valor, tipo: tipoTransacao };
            const mesPath = `${DB_PATH_ROOT_GASTOS}/${ano}/${mes}`;
            
            try {
                const mesMetaRef = ref(database, mesPath);
                const mesSnapshot = await get(mesMetaRef);
                if (!mesSnapshot.exists() || !mesSnapshot.val()?.nome) {
                    await update(mesMetaRef, { nome: mesesNomes[mes] || `Mês ${mes}`, ano: ano });
                }
                const transacoesRef = ref(database, `${mesPath}/transacoes`);
                const novaTransacaoRef = push(transacoesRef);
                await set(novaTransacaoRef, transacaoData);
                showGlobalNotification(`Transação de gastos (${tipoTransacao}) registrada!`, "success");
                
                editandoTransacaoIdGastos = null;
                cancelarAdicaoEdicaoTransacaoGastos();
                // renderizarDetalhesDoMesGastos will be called by onValue listener
            } catch (error) {
                console.error("Erro ao salvar transação de gastos no Firebase:", error);
                showGlobalNotification("Falha ao comunicar com a base de gastos.", "error");
            } finally {
                hideGlobalLoading();
            }
        }
        async function excluirTransacaoGastos(ano, mes, idTransacaoFirebase) { /* ... (implementation from previous response) ... */ 
            showConfirmationModalGastos(
                "Confirmar Ejeção de Gasto",
                "Tem certeza que deseja ejetar este registro de gasto? Esta manobra não pode ser desfeita.",
                async () => {
                    showGlobalLoading();
                    const transacaoRef = ref(database, `${DB_PATH_ROOT_GASTOS}/${ano}/${mes}/transacoes/${idTransacaoFirebase}`);
                    try {
                        await remove(transacaoRef);
                        showGlobalNotification("Registro de gasto ejetado!", "info");
                        // renderizarDetalhesDoMesGastos will be called by onValue
                    } catch (error) {
                        console.error("Erro ao excluir transação de gastos:", error);
                        showGlobalNotification("Falha ao ejetar registro de gasto.", "error");
                    } finally {
                        hideGlobalLoading();
                    }
                },
                () => { showGlobalNotification("Ejeção de gasto cancelada.", "info"); }
            );
        }
        window.cancelarAdicaoEdicaoTransacaoGastos = function() { /* ... (implementation from previous response, ensure scoped selectors) ... */ 
             const { ano, mes } = dataSelecionadaAtualGastos;
            if (ano && mes) {
                const formContainer = gastosView.querySelector(`#gastosFormContainer-${ano}-${mes}`);
                if (formContainer) formContainer.innerHTML = '';
            }
            editandoTransacaoIdGastos = null;
            if (currentEditingRowGastos) {
                restaurarLinhaTabelaGastos(currentEditingRowGastos, false);
                currentEditingRowGastos = null;
            }
        }
        function iniciarEdicaoTransacaoGastos(ano, mes, idTransacao, trElement) { /* ... (implementation from previous response, use scoped class names for inputs/buttons) ... */ 
             cancelarAdicaoEdicaoTransacaoGastos(); 
            if (currentEditingRowGastos && currentEditingRowGastos !== trElement) {
               restaurarLinhaTabelaGastos(currentEditingRowGastos, false);
            }
            currentEditingRowGastos = trElement;
            editandoTransacaoIdGastos = idTransacao;
            const transacao = todosOsGastosCache[ano]?.[mes]?.transacoes.find(t => t.id === idTransacao);
            if (!transacao) return;

            trElement.classList.add('editing-row-active'); 
            trElement.cells[0].innerHTML = `<input type="date" value="${transacao.data}" class="edit-inline-data-gasto" min="${ano}-${mes}-01" max="${ano}-${mes}-${new Date(parseInt(ano), parseInt(mes), 0).getDate()}">`;
            trElement.cells[1].innerHTML = `<input type="text" value="${transacao.motivo}" class="edit-inline-motivo-gasto">`;
            trElement.cells[2].innerHTML = `<input type="text" value="${transacao.quem}" class="edit-inline-quem-gasto">`;
            trElement.cells[3].innerHTML = `<input type="number" step="0.01" value="${transacao.valor}" class="edit-inline-valor-gasto">`;
            trElement.cells[4].innerHTML = `<select class="edit-inline-tipo-gasto"><option value="entrada" ${transacao.tipo === 'entrada' ? 'selected' : ''}>Entrada</option><option value="saida" ${transacao.tipo === 'saida' ? 'selected' : ''}>Saída</option></select>`;
            trElement.cells[6].innerHTML = `<button title="Salvar" class="btn-salvar-inline-gasto">💾</button><button title="Cancelar" class="btn-cancelar-inline-gasto">↩️</button>`;

            trElement.querySelector('.btn-salvar-inline-gasto').onclick = () => salvarEdicaoInlineFirebaseGastos(ano, mes, idTransacao, trElement);
            trElement.querySelector('.btn-cancelar-inline-gasto').onclick = () => restaurarLinhaTabelaGastos(trElement, true);
        }
        async function salvarEdicaoInlineFirebaseGastos(ano, mes, idTransacaoFirebase, trElement) { /* ... (implementation from previous response, use scoped class names for inputs) ... */ 
            showGlobalLoading();
            const data = trElement.querySelector('.edit-inline-data-gasto').value;
            const motivo = trElement.querySelector('.edit-inline-motivo-gasto').value.trim();
            const quem = trElement.querySelector('.edit-inline-quem-gasto').value.trim();
            const valor = parseFloat(trElement.querySelector('.edit-inline-valor-gasto').value);
            const tipo = trElement.querySelector('.edit-inline-tipo-gasto').value;

            if (!data || !motivo || !quem || isNaN(valor) || valor <= 0) {
                showGlobalNotification("Campos de gasto inválidos.", "warning"); hideGlobalLoading(); return;
            }
            const transacaoData = { data, motivo, quem, valor, tipo };
            const transacaoRef = ref(database, `${DB_PATH_ROOT_GASTOS}/${ano}/${mes}/transacoes/${idTransacaoFirebase}`);
            try {
                await update(transacaoRef, transacaoData);
                showGlobalNotification("Alterações de gasto sincronizadas!", "success");
                // onValue listener will handle UI update
                editandoTransacaoIdGastos = null;
                currentEditingRowGastos = null;
            } catch (error) {
                console.error("Erro ao salvar edição inline de gastos:", error);
                showGlobalNotification("Falha ao sincronizar edição de gasto.", "error");
                restaurarLinhaTabelaGastos(trElement, false);
            } finally {
                hideGlobalLoading();
            }
        }
        function restaurarLinhaTabelaGastos(trElement, reRenderizarMesCompleto = true) { /* ... (implementation from previous response, ensure scoped button classes) ... */ 
            const { ano, mes } = dataSelecionadaAtualGastos;
            if (reRenderizarMesCompleto && ano && mes) {
                 renderizarDetalhesDoMesGastos(ano, mes);
            } else if (trElement && todosOsGastosCache[ano]?.[mes]) {
                const idTransacao = trElement.dataset.id;
                const transacaoOriginal = todosOsGastosCache[ano][mes].transacoes.find(t => t.id === idTransacao);
                if (transacaoOriginal) {
                    trElement.cells[0].textContent = new Date(transacaoOriginal.data + 'T00:00:00Z').toLocaleDateString('pt-BR', {timeZone: 'UTC'});
                    trElement.cells[1].textContent = transacaoOriginal.motivo || '-';
                    trElement.cells[2].textContent = transacaoOriginal.quem || '-';
                    // Correctly re-create the TD content, not assign to innerHTML of existing TD
                    trElement.cells[3].className = `currency ${transacaoOriginal.tipo === 'entrada' ? 'positivo' : 'negativo'}`;
                    trElement.cells[3].textContent = formatCurrencyGastos(transacaoOriginal.valor);
                    trElement.cells[4].className = `center-text ${transacaoOriginal.tipo === 'entrada' ? 'positivo' : 'negativo'}`;
                    trElement.cells[4].textContent = transacaoOriginal.tipo === 'entrada' ? 'Entrada' : 'Saída';
                    
                    // For saldo, we'd ideally need to re-calculate or just re-render the whole table for accuracy after an edit.
                    // For a simple visual restoration without full re-render:
                    const { transacoesComSaldo } = calcularTotaisMesGastos(todosOsGastosCache[ano][mes].transacoes);
                    const transacaoRestauradaComSaldo = transacoesComSaldo.find(t => t.id === idTransacao);
                    if (transacaoRestauradaComSaldo) {
                        trElement.cells[5].className = `currency ${transacaoRestauradaComSaldo.saldoApos < 0 ? 'negativo' : 'positivo'}`;
                        trElement.cells[5].textContent = formatCurrencyGastos(transacaoRestauradaComSaldo.saldoApos);
                    } else {
                        trElement.cells[5].textContent = "N/A"; // Fallback if saldo can't be found
                    }

                    trElement.cells[6].innerHTML = `<button class="btn-editar-gasto" title="Editar">✏️</button><button class="btn-excluir-gasto" title="Excluir">🗑️</button>`;
                    
                    trElement.querySelector('.btn-editar-gasto').onclick = () => iniciarEdicaoTransacaoGastos(ano, mes, idTransacao, trElement);
                    trElement.querySelector('.btn-excluir-gasto').onclick = () => excluirTransacaoGastos(ano, mes, idTransacao);
                    trElement.classList.remove('editing-row-active');
                }
            }
            currentEditingRowGastos = null;
            editandoTransacaoIdGastos = null;
        }
        async function handleDateSelectionGastos() { /* ... (same as before) ... */ 
             const valorSelecionado = datePickerMesAnoEl.value;
            if (valorSelecionado) {
                const [ano, mes] = valorSelecionado.split('-');
                // renderizarDetalhesDoMesGastos will be called by onValue listener
                // but we need to set the current selection for onValue to use
                dataSelecionadaAtualGastos = { ano, mes };
                // Trigger a re-render based on the new selection if data is already in cache
                // This is needed because onValue might not fire if only the date picker changes but not the underlying data.
                if (todosOsGastosCache[ano] && todosOsGastosCache[ano][mes]) {
                     await renderizarDetalhesDoMesGastos(ano, mes);
                } else {
                    // If data for this month isn't in cache, onValue will handle it when it arrives,
                    // or renderizarDetalhesDoMesGastos will show a placeholder.
                    // For now, let's force a render attempt to show placeholder or data.
                    await renderizarDetalhesDoMesGastos(ano, mes);
                }

            } else {
                mesDetalhesContainerEl.innerHTML = `<div class="placeholder-mes"><span>🌠</span>Selecione um mês/ano para análise de gastos.</div>`;
                dataSelecionadaAtualGastos = { ano: null, mes: null };
            }
        }
        datePickerMesAnoEl.addEventListener('change', handleDateSelectionGastos);
        window.refreshGastosPage = function() {
            console.log("Refreshing Gastos Page Data");
            if (dataSelecionadaAtualGastos.ano && dataSelecionadaAtualGastos.mes) {
                renderizarDetalhesDoMesGastos(dataSelecionadaAtualGastos.ano, dataSelecionadaAtualGastos.mes);
            } else {
                setDefaultMonthPickerGastos(); // Or re-fetch if preferred
            }
        };

        // Real-time listener for Gastos
        const gastosDbRef = ref(database, DB_PATH_ROOT_GASTOS);
        onValue(gastosDbRef, (snapshot) => {
            showGlobalLoading();
            console.log("Dados de Gastos recebidos/atualizados do Firebase.");
            if (snapshot.exists()) {
                todosOsGastosCache = snapshot.val();
            } else {
                todosOsGastosCache = {};
                console.log("Nenhum dado de gasto global encontrado no Firebase.");
            }
            
            if (document.getElementById('page-gastos').classList.contains('hidden')) {
                 console.log("Gastos page is hidden, deferring render.");
                 hideGlobalLoading();
            } else {
                // If a month is selected, re-render it. Otherwise, set default picker.
                if (dataSelecionadaAtualGastos.ano && dataSelecionadaAtualGastos.mes) {
                    renderizarDetalhesDoMesGastos(dataSelecionadaAtualGastos.ano, dataSelecionadaAtualGastos.mes);
                } else {
                    setDefaultMonthPickerGastos();
                }
                hideGlobalLoading(); // Ensure loading is hidden after processing
            }

        }, (error) => {
            console.error("Erro ao escutar dados de Gastos do Firebase:", error);
            showGlobalNotification("Falha na conexão em tempo real com a base de gastos.", "error");
            todosOsGastosCache = {};
            if (!document.getElementById('page-gastos').classList.contains('hidden')) {
                 setDefaultMonthPickerGastos(); // Attempt to set a default or show placeholder
            }
            hideGlobalLoading();
        });
      } 


      // --- Initialize the default page ---
      document.addEventListener('DOMContentLoaded', () => {
          showPage('page-patrimonio'); 
      });

    </script>

    <script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/service-worker.js')
        .then(reg => console.log('Service Worker registrado!', reg))
        .catch(err => console.error('Erro no Service Worker:', err));
    });
  }
</script>

</body>
</html>
